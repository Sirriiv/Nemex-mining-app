<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security - NemexCoin</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ... (keep all your existing styles exactly the same) ... */
    </style>
</head>
<body>
    <!-- ... (keep all your existing HTML exactly the same) ... -->

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://bjulifvbfogymoduxnzl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqdWxpZnZiZm9neW1vZHV4bnpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MTk0NDMsImV4cCI6MjA3NTQ5NTQ0M30.MPxDDybfODRnzvrFNZ0TQKkV983tGUFriHYgIpa_LaU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Check authentication on page load
        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error || !session) {
                    console.log('‚ùå No active session, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                const { data: user, error: userError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                    
                if (userError || !user) {
                    console.error('‚ùå User not found in profiles table');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('‚úÖ User authenticated:', user.email);
                return user;
            } catch (error) {
                console.error('‚ùå Auth check error:', error);
                window.location.href = 'login.html';
            }
        }

        // Security functions
        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('currentPassword').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const changePasswordBtn = document.getElementById('changePasswordBtn');

            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            try {
                if (!currentPassword || !newPassword || !confirmPassword) {
                    throw new Error('All fields are required');
                }

                if (newPassword.length < 6) {
                    throw new Error('New password must be at least 6 characters long');
                }

                if (newPassword !== confirmPassword) {
                    throw new Error('New passwords do not match');
                }

                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                if (sessionError || !session) {
                    throw new Error('User not logged in');
                }

                const { data: user, error: userError } = await supabase
                    .from('profiles')
                    .select('password')
                    .eq('id', session.user.id)
                    .single();

                if (userError || !user) {
                    throw new Error('Failed to verify current password');
                }

                if (user.password !== currentPassword) {
                    throw new Error('Current password is incorrect');
                }

                changePasswordBtn.disabled = true;
                changePasswordBtn.textContent = 'Changing...';

                // Update password in Supabase Auth
                const { error: authUpdateError } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (authUpdateError) {
                    throw new Error('Failed to update password: ' + authUpdateError.message);
                }

                // Update password in profiles table
                const { error: profileUpdateError } = await supabase
                    .from('profiles')
                    .update({ 
                        password: newPassword,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', session.user.id);

                if (profileUpdateError) {
                    throw new Error('Failed to update password in database');
                }

                successMessage.textContent = 'Password changed successfully!';
                successMessage.style.display = 'block';

                setTimeout(() => {
                    closePasswordModal();
                    loadPasswordLastChanged();
                    changePasswordBtn.disabled = false;
                    changePasswordBtn.textContent = 'Change Password';
                }, 1500);

            } catch (error) {
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';
                changePasswordBtn.disabled = false;
                changePasswordBtn.textContent = 'Change Password';
            }
        }

        async function loadPasswordLastChanged() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const { data: user, error } = await supabase
                    .from('profiles')
                    .select('updated_at')
                    .eq('id', session.user.id)
                    .single();

                if (!error && user) {
                    const lastChanged = user.updated_at;
                    if (lastChanged) {
                        const date = new Date(lastChanged);
                        const now = new Date();
                        const diffTime = Math.abs(now - date);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        let displayText = 'Last changed: ';
                        if (diffDays === 1) {
                            displayText += 'Today';
                        } else if (diffDays === 2) {
                            displayText += 'Yesterday';
                        } else if (diffDays < 7) {
                            displayText += `${diffDays - 1} days ago`;
                        } else if (diffDays < 30) {
                            displayText += `${Math.floor(diffDays / 7)} weeks ago`;
                        } else {
                            displayText += date.toLocaleDateString();
                        }

                        document.getElementById('passwordLastChanged').textContent = displayText;
                    } else {
                        document.getElementById('passwordLastChanged').textContent = 'Last changed: Never';
                    }
                }
            } catch (error) {
                document.getElementById('passwordLastChanged').textContent = 'Last changed: Unknown';
            }
        }

        // 2FA Functions - COMPLETELY FIXED
        async function open2FAModal() {
            document.getElementById('twoFactorModal').style.display = 'flex';
            await generateQRCode();
        }

        function close2FAModal() {
            document.getElementById('twoFactorModal').style.display = 'none';
            showQRStep();
        }

        // FIXED: QR Code generation with proper gold dots
        async function generateQRCode() {
            const secretKey = await getOrCreateSecretKey();
            document.getElementById('manualKey').textContent = secretKey;

            const { data: { session } } = await supabase.auth.getSession();
            const userEmail = session?.user?.email || "user@nemexcoin.com";
            const issuer = "NemexCoin";
            const otpAuthUri = `otpauth://totp/${issuer}:${userEmail}?secret=${secretKey}&issuer=${issuer}&algorithm=SHA1&digits=6&period=30`;

            const qrCodeElement = document.getElementById('qrCode');
            qrCodeElement.innerHTML = '';

            // FIXED: Create proper QR code with gold dots on black background
            QRCode.toCanvas(qrCodeElement, otpAuthUri, {
                width: 200,
                height: 200,
                margin: 1,
                colorDark: "#d4af37",  // GOLD dots
                colorLight: "#000000", // BLACK background
                correctLevel: QRCode.CorrectLevel.H
            }, function(error) {
                if (error) {
                    console.error('QR Code generation error:', error);
                    createFallbackQRCode();
                }
            });
        }

        async function getOrCreateSecretKey() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    return generateSecretKey();
                }

                const { data: user, error } = await supabase
                    .from('profiles')
                    .select('two_factor_secret')
                    .eq('id', session.user.id)
                    .single();

                if (!error && user && user.two_factor_secret) {
                    return user.two_factor_secret;
                }

                const newSecretKey = generateSecretKey();
                return newSecretKey;

            } catch (error) {
                return generateSecretKey();
            }
        }

        function generateSecretKey() {
            const base32Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            for (let i = 0; i < 32; i++) {
                secret += base32Chars.charAt(Math.floor(Math.random() * base32Chars.length));
            }
            return secret;
        }

        function createFallbackQRCode() {
            const qrCodeElement = document.getElementById('qrCode');
            qrCodeElement.innerHTML = '';

            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');

            // Black background
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 200, 200);

            // Gold dots
            ctx.fillStyle = '#d4af37';
            
            // Position markers
            ctx.fillRect(20, 20, 40, 40);
            ctx.fillRect(140, 20, 40, 40);
            ctx.fillRect(20, 140, 40, 40);
            
            // Pattern
            for (let i = 0; i < 12; i++) {
                for (let j = 0; j < 12; j++) {
                    if ((i + j) % 3 === 0 || (i * j) % 5 === 0) {
                        ctx.fillRect(30 + i * 12, 30 + j * 12, 8, 8);
                    }
                }
            }

            qrCodeElement.appendChild(canvas);
        }

        function showQRStep() {
            document.getElementById('setupStep1').style.display = 'block';
            document.getElementById('setupStep2').style.display = 'none';
        }

        function showVerificationStep() {
            document.getElementById('setupStep1').style.display = 'none';
            document.getElementById('setupStep2').style.display = 'block';
            document.getElementById('verificationCode').focus();
        }

        function validateVerificationCode() {
            const code = document.getElementById('verificationCode').value;
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = !/^\d{6}$/.test(code);
        }

        // FIXED: Proper 2FA verification with TOTP
        async function verify2FACode() {
            const code = document.getElementById('verificationCode').value;
            const verifyBtn = document.getElementById('verifyBtn');

            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';

            try {
                const secretKey = document.getElementById('manualKey').textContent;

                // FIXED: Actually verify the TOTP code
                const isValid = await verifyTOTPCode(code, secretKey);
                
                if (!isValid) {
                    throw new Error('Invalid verification code. Please try again.');
                }

                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    throw new Error('User not logged in');
                }

                // Generate unique backup codes for this user
                const backupCodes = generateBackupCodes();

                // Save 2FA AND backup codes to database
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        two_factor_secret: secretKey,
                        two_factor_enabled: true,
                        backup_codes: backupCodes, // Store backup codes
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', session.user.id);

                if (error) {
                    throw new Error('Failed to enable 2FA');
                }

                // Show backup codes to user
                showBackupCodesModal(backupCodes);

            } catch (error) {
                alert('Failed to enable 2FA: ' + error.message);
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify & Enable';
            }
        }

        // FIXED: Proper TOTP verification
        async function verifyTOTPCode(code, secret) {
            try {
                // Import the OTPAuth library properly
                const OTPAuth = window.OTPAuth;
                
                const totp = new OTPAuth.TOTP({
                    issuer: "NemexCoin",
                    label: "user@nemexcoin.com",
                    algorithm: "SHA1",
                    digits: 6,
                    period: 30,
                    secret: OTPAuth.Secret.fromBase32(secret)
                });

                // Validate with 1-step window for time sync issues
                const isValid = totp.validate({ token: code, window: 1 }) !== null;
                
                console.log('üîê TOTP Verification:', {
                    code: code,
                    secret: secret,
                    isValid: isValid
                });
                
                return isValid;
            } catch (error) {
                console.error('TOTP verification error:', error);
                return false;
            }
        }

        // FIXED: Generate unique backup codes for each user
        function generateBackupCodes() {
            const codes = [];
            for (let i = 0; i < 8; i++) {
                const code = generateBackupCode();
                codes.push({
                    code: code,
                    used: false
                });
            }
            return codes;
        }

        function generateBackupCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 10; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // FIXED: Show actual backup codes from database
        function showBackupCodesModal(backupCodes) {
            document.getElementById('twoFactorModal').style.display = 'none';
            
            const backupCodesContainer = document.querySelector('.backup-codes');
            backupCodesContainer.innerHTML = '';
            
            // Display the actual backup codes
            backupCodes.forEach(backupCode => {
                const codeElement = document.createElement('div');
                codeElement.className = 'backup-code';
                codeElement.textContent = backupCode.code;
                backupCodesContainer.appendChild(codeElement);
            });
            
            document.getElementById('backupCodesModal').style.display = 'flex';
        }

        function closeBackupCodesModal() {
            document.getElementById('backupCodesModal').style.display = 'none';
            
            // Update UI to show 2FA is active
            document.getElementById('twoFactorStatus').textContent = 'Active';
            document.getElementById('twoFactorStatus').classList.remove('inactive');
            document.getElementById('twoFactorStatus').classList.add('active');
        }

        // Load current 2FA status
        async function load2FAStatus() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const { data: user, error } = await supabase
                    .from('profiles')
                    .select('two_factor_enabled')
                    .eq('id', session.user.id)
                    .single();

                if (!error && user && user.two_factor_enabled) {
                    document.getElementById('twoFactorStatus').textContent = 'Active';
                    document.getElementById('twoFactorStatus').classList.remove('inactive');
                    document.getElementById('twoFactorStatus').classList.add('active');
                }
            } catch (error) {
                console.error('Error loading 2FA status:', error);
            }
        }

        // Disable 2FA
        async function disable2FA() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        two_factor_enabled: false,
                        backup_codes: null, // Clear backup codes when disabling
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', session.user.id);

                if (error) {
                    throw new Error('Failed to disable 2FA');
                }

                document.getElementById('twoFactorStatus').textContent = 'Inactive';
                document.getElementById('twoFactorStatus').classList.remove('active');
                document.getElementById('twoFactorStatus').classList.add('inactive');

                alert('Two-Factor Authentication has been disabled.');

            } catch (error) {
                alert('Failed to disable 2FA: ' + error.message);
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async function() {
            const user = await checkAuth();
            if (!user) return;

            // Load current data
            load2FAStatus();
            loadPasswordLastChanged();

            // Add click handler for 2FA item
            const twoFactorItem = document.querySelector('.security-item:nth-child(2)');
            twoFactorItem.addEventListener('click', function() {
                const status = document.getElementById('twoFactorStatus');
                if (status.classList.contains('inactive')) {
                    open2FAModal();
                } else {
                    if (confirm('Are you sure you want to disable Two-Factor Authentication? This will reduce your account security.')) {
                        disable2FA();
                    }
                }
            });
        });
    </script>
</body>
</html>