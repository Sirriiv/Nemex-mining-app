<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy NMXp - NemexCoin</title>
    <style>
        /* ... (keep all your existing styles exactly the same) ... */
    </style>
</head>
<body>
    <!-- ... (keep all your existing HTML exactly the same) ... -->

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://bjulifvbfogymoduxnzl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqdWxpZnZiZm9neW1vZHV4bnpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MTk0NDMsImV4cCI6MjA3NTQ5NTQ0M30.MPxDDybfODRnzvrFNZ0TQKkV983tGUFriHYgIpa_LaU';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        let selectedPackage = null;
        let currentUser = null;
        let currentBalance = 0;

        // Load user data on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        async function initializePage() {
            try {
                // Get current user session
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = session.user;
                console.log('User ID:', currentUser.id);

                // Load balance immediately using the same method as dashboard
                loadBalanceFromDashboard();

            } catch (error) {
                console.error('Error initializing page:', error);
                showBalanceError();
            }
        }

        function loadBalanceFromDashboard() {
            console.log('=== DEBUG: Searching for balance ===');
            
            // Get ALL localStorage items to see what's available
            const allLocalStorage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allLocalStorage[key] = localStorage.getItem(key);
            }
            console.log('All localStorage:', allLocalStorage);

            // Get ALL sessionStorage items
            const allSessionStorage = {};
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                allSessionStorage[key] = sessionStorage.getItem(key);
            }
            console.log('All sessionStorage:', allSessionStorage);

            // Check common balance key names
            const balanceKeys = [
                'userBalance', 'nmxpBalance', 'currentBalance', 'balance',
                'nmxp_balance', 'user_balance', 'walletBalance',
                'sb-bjulifvbfogymoduxnzl-auth-token', // Supabase token might have user data
                'supabase.auth.token' // Another common Supabase token key
            ];

            let foundBalance = null;
            let foundKey = null;

            // Check all possible keys
            for (const key of balanceKeys) {
                const value = localStorage.getItem(key) || sessionStorage.getItem(key);
                if (value && !key.includes('token')) { // Skip token keys for now
                    console.log(`Found potential balance in ${key}:`, value);
                    // Try to parse as JSON first (in case it's an object)
                    try {
                        const parsed = JSON.parse(value);
                        if (typeof parsed === 'object' && parsed !== null) {
                            // Look for balance in object
                            const balanceInObject = parsed.nmxp_balance || parsed.balance || parsed.userBalance || parsed.nmxpBalance;
                            if (balanceInObject !== undefined) {
                                foundBalance = balanceInObject;
                                foundKey = key;
                                console.log(`Found balance in ${key} object:`, foundBalance);
                                break;
                            }
                        }
                    } catch (e) {
                        // Not JSON, try as direct number
                        const numValue = parseFloat(value);
                        if (!isNaN(numValue)) {
                            foundBalance = numValue;
                            foundKey = key;
                            console.log(`Found balance in ${key} as number:`, foundBalance);
                            break;
                        }
                    }
                }
            }

            // If no balance found in dedicated keys, check Supabase auth token
            if (!foundBalance) {
                console.log('Checking Supabase auth tokens for balance data...');
                const supabaseToken = localStorage.getItem('sb-bjulifvbfogymoduxnzl-auth-token') || 
                                    localStorage.getItem('supabase.auth.token');
                if (supabaseToken) {
                    try {
                        const tokenData = JSON.parse(supabaseToken);
                        console.log('Supabase token data:', tokenData);
                        // Sometimes user data is in the token
                        if (tokenData.user && tokenData.user.user_metadata) {
                            const balanceFromToken = tokenData.user.user_metadata.nmxp_balance || 
                                                   tokenData.user.user_metadata.balance;
                            if (balanceFromToken) {
                                foundBalance = balanceFromToken;
                                foundKey = 'supabase_token';
                            }
                        }
                    } catch (e) {
                        console.log('Could not parse Supabase token');
                    }
                }
            }

            if (foundBalance) {
                currentBalance = parseFloat(foundBalance) || 0;
                updateBalanceDisplay();
                console.log(`✅ Balance loaded from ${foundKey}:`, currentBalance);
            } else {
                console.log('❌ No balance found in storage, using database fallback');
                // If no balance found, try to fetch from database as fallback
                fetchBalanceFromDatabase();
            }
        }

        async function fetchBalanceFromDatabase() {
            try {
                console.log('Fetching balance from database for user:', currentUser.id);
                
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('nmxp_balance')
                    .eq('id', currentUser.id)
                    .single();

                if (error) {
                    console.warn('Database fetch failed:', error);
                    // Set a default balance
                    currentBalance = 0;
                    updateBalanceDisplay();
                    return;
                }

                if (profile && profile.nmxp_balance !== undefined) {
                    currentBalance = profile.nmxp_balance || 0;
                    updateBalanceDisplay();
                    console.log('Balance loaded from database:', currentBalance);
                    
                    // Also store it for future use
                    localStorage.setItem('userBalance', currentBalance.toString());
                }

            } catch (error) {
                console.warn('Error fetching from database:', error);
                currentBalance = 0;
                updateBalanceDisplay();
            }
        }

        function showBalanceError() {
            document.getElementById('currentBalance').innerHTML = 
                '<span style="color: var(--danger);">Error loading balance</span>';
        }

        function updateBalanceDisplay() {
            const balanceElement = document.getElementById('currentBalance');
            balanceElement.innerHTML = `${currentBalance.toLocaleString()} NMXp`;

            // Add animation for balance updates
            balanceElement.style.transform = 'scale(1.05)';
            setTimeout(() => {
                balanceElement.style.transform = 'scale(1)';
            }, 300);
        }

        // Listen for balance updates from dashboard
        window.addEventListener('storage', function(e) {
            console.log('Storage event detected:', e.key, e.newValue);
            if (e.key && (e.key.includes('balance') || e.key.includes('Balance'))) {
                currentBalance = parseFloat(e.newValue) || 0;
                updateBalanceDisplay();
                console.log('Balance updated from storage:', currentBalance);
            }
        });

        // Also check for balance updates when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Refresh balance when user returns to this page
                loadBalanceFromDashboard();
            }
        });

        // Periodically check for balance updates (every 30 seconds)
        setInterval(loadBalanceFromDashboard, 30000);

        // ... (rest of your functions remain exactly the same) ...
    </script>
</body>
</html>