// UPDATED: Load packages from database with purchase limits
async function loadPackages() {
    try {
        const { data: packages, error } = await supabaseClient
            .from('package_types')
            .select('*')
            .eq('is_active', true)
            .order('package_amount');

        if (error) {
            console.error('Error loading packages:', error);
            return;
        }

        availablePackages = packages || [];
        renderPackages();
        
    } catch (error) {
        console.error('Error loading packages:', error);
    }
}

// UPDATED: Render packages with purchase limits using your actual table structure
function renderPackages() {
    const packagesGrid = document.getElementById('packagesGrid');
    if (!packagesGrid) return;

    if (availablePackages.length === 0) {
        packagesGrid.innerHTML = '<div class="empty-state">No packages available</div>';
        return;
    }

    packagesGrid.innerHTML = availablePackages.map(pkg => {
        const isSoldOut = pkg.purchase_limit <= 0; // CHANGED: Use purchase_limit
        const isLowStock = pkg.purchase_limit <= 3 && pkg.purchase_limit > 0; // CHANGED: Use purchase_limit
        const remainingClass = isLowStock ? 'remaining-badge low' : 'remaining-badge';

        return `
            <div class="package-card ${pkg.is_vip ? 'vip' : ''} ${isSoldOut ? 'sold-out' : ''}" 
                 ${!isSoldOut ? `onclick="selectPackage(this, '${pkg.id}')"` : ''}>
                ${pkg.is_vip ? '<div class="vip-badge">VIP Package</div>' : ''}
                <div class="package-amount">${pkg.package_amount.toLocaleString()} NMXp</div>
                <div class="package-price">$${pkg.price_usd} USDT</div>
                <div class="package-purchase-limit">
                    ${pkg.purchase_limit > 0  // CHANGED: Use purchase_limit
                        ? `Can purchase ${pkg.purchase_limit} more times` 
                        : 'Sold out'}
                </div>
                ${pkg.purchase_limit > 0 && pkg.purchase_limit <= 5 ? `  // CHANGED: Use purchase_limit
                    <div class="${remainingClass}">
                        Only ${pkg.purchase_limit} left!  // CHANGED: Use purchase_limit
                    </div>
                ` : ''}
                ${pkg.bonus_amount > 0 ? `
                    <div class="package-bonus">+${pkg.bonus_amount} Bonus NMXp</div>
                ` : ''}
            </div>
        `;
    }).join('');
}

// UPDATED: Select package with database check using purchase_limit
function selectPackage(element, packageId) {
    const packageData = availablePackages.find(pkg => pkg.id === packageId);
    if (!packageData) return;

    // Check if package is sold out using purchase_limit
    if (packageData.purchase_limit <= 0) {  // CHANGED: Use purchase_limit
        alert('âŒ This package is sold out! Please select another package.');
        return;
    }

    const packages = document.querySelectorAll('.package-card');
    if (packages) {
        packages.forEach(card => {
            card.classList.remove('selected');
        });
    }
    element.classList.add('selected');
    
    selectedPackage = {
        element: element