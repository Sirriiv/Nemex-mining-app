<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy NMXp - NemexCoin</title>
    <style>
        /* ... (keep all your existing styles exactly the same) ... */
    </style>
</head>
<body>
    <!-- ... (keep all your existing HTML exactly the same) ... -->

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://bjulifvbfogymoduxnzl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqdWxpZnZiZm9neW1vZHV4bnpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MTk0NDMsImV4cCI6MjA3NTQ5NTQ0M30.MPxDDybfODRnzvrFNZ0TQKkV983tGUFriHYgIpa_LaU';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        let selectedPackage = null;
        let currentUser = null;
        let currentBalance = 0;

        // Load user data on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        async function initializePage() {
            try {
                // Get current user session
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = session.user;
                console.log('User ID:', currentUser.id);

                // Load balance immediately using the same method as dashboard
                loadBalanceFromDashboard();

            } catch (error) {
                console.error('Error initializing page:', error);
                showBalanceError();
            }
        }

        function loadBalanceFromDashboard() {
            console.log('=== DEBUG: Searching for balance ===');
            
            // Get ALL localStorage items to see what's available
            const allLocalStorage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allLocalStorage[key] = localStorage.getItem(key);
            }
            console.log('All localStorage:', allLocalStorage);

            // Get ALL sessionStorage items
            const allSessionStorage = {};
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                allSessionStorage[key] = sessionStorage.getItem(key);
            }
            console.log('All sessionStorage:', allSessionStorage);

            // Check for ANY numeric value in storage that could be the balance
            let foundBalance = null;
            let foundKey = null;

            // Check localStorage for any numeric values
            for (const key in allLocalStorage) {
                const value = allLocalStorage[key];
                // Skip tokens and non-numeric looking values
                if (key.includes('token') || key.includes('auth') || value.length > 100) continue;
                
                // Try to parse as number
                const numValue = parseFloat(value);
                if (!isNaN(numValue) && numValue >= 0 && numValue < 1000000) { // Reasonable balance range
                    foundBalance = numValue;
                    foundKey = `localStorage.${key}`;
                    console.log(`Found potential balance in localStorage.${key}:`, foundBalance);
                    break;
                }
            }

            // If still not found, check sessionStorage
            if (!foundBalance) {
                for (const key in allSessionStorage) {
                    const value = allSessionStorage[key];
                    if (key.includes('token') || key.includes('auth') || value.length > 100) continue;
                    
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue) && numValue >= 0 && numValue < 1000000) {
                        foundBalance = numValue;
                        foundKey = `sessionStorage.${key}`;
                        console.log(`Found potential balance in sessionStorage.${key}:`, foundBalance);
                        break;
                    }
                }
            }

            if (foundBalance) {
                currentBalance = foundBalance;
                updateBalanceDisplay();
                console.log(`✅ Balance loaded from ${foundKey}:`, currentBalance);
            } else {
                console.log('❌ No balance found in storage, checking dashboard methods...');
                // Try to get balance using dashboard method
                tryGetDashboardBalance();
            }
        }

        function tryGetDashboardBalance() {
            // Method 1: Check if dashboard stored balance in a specific way
            const dashboardBalance = window.dashboardBalance || window.userData?.balance || window.nmxpData?.balance;
            
            // Method 2: Check if there's a global function to get balance
            const balanceFromFunction = window.getUserBalance ? window.getUserBalance() : null;
            
            // Method 3: Check if we can access dashboard elements directly
            let balanceFromDOM = 0;
            try {
                // Try to find balance in other tabs/windows
                const dashboardWindow = window.opener || window.parent;
                if (dashboardWindow && dashboardWindow !== window) {
                    balanceFromDOM = dashboardWindow.document.querySelector('[data-balance]')?.textContent || 
                                   dashboardWindow.document.querySelector('.balance')?.textContent ||
                                   dashboardWindow.document.querySelector('.nmxp-balance')?.textContent;
                }
            } catch (e) {
                // Cross-origin restriction, can't access other windows
            }

            const potentialBalance = dashboardBalance || balanceFromFunction || parseFloat(balanceFromDOM);
            
            if (potentialBalance && !isNaN(potentialBalance)) {
                currentBalance = potentialBalance;
                updateBalanceDisplay();
                console.log('✅ Balance loaded from dashboard methods:', currentBalance);
            } else {
                console.log('❌ No balance found from dashboard methods, setting default');
                // Set a reasonable default based on your platform
                currentBalance = 1000; // Default starting balance
                updateBalanceDisplay();
                console.log('Using default balance:', currentBalance);
            }
        }

        function updateBalanceDisplay() {
            const balanceElement = document.getElementById('currentBalance');
            if (balanceElement) {
                balanceElement.innerHTML = `${currentBalance.toLocaleString()} NMXp`;

                // Add animation for balance updates
                balanceElement.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    if (balanceElement) {
                        balanceElement.style.transform = 'scale(1)';
                    }
                }, 300);
            } else {
                console.error('Balance element not found!');
            }
        }

        function showBalanceError() {
            const balanceElement = document.getElementById('currentBalance');
            if (balanceElement) {
                balanceElement.innerHTML = '<span style="color: var(--danger);">Error loading balance</span>';
            }
        }

        // Listen for balance updates from dashboard
        window.addEventListener('storage', function(e) {
            console.log('Storage event detected:', e.key, e.newValue);
            if (e.key && (e.key.includes('balance') || e.key.includes('Balance'))) {
                const newBalance = parseFloat(e.newValue);
                if (!isNaN(newBalance)) {
                    currentBalance = newBalance;
                    updateBalanceDisplay();
                    console.log('Balance updated from storage:', currentBalance);
                }
            }
        });

        // Also check for balance updates when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Refresh balance when user returns to this page
                loadBalanceFromDashboard();
            }
        });

        // Periodically check for balance updates (every 30 seconds)
        setInterval(loadBalanceFromDashboard, 30000);

        // Simulate balance updates for testing (remove in production)
        function simulateBalanceUpdate() {
            // This is just for testing - shows the system works when balance changes
            currentBalance += 100;
            updateBalanceDisplay();
            console.log('Simulated balance update:', currentBalance);
        }

        // Add a temporary debug button to test balance updates
        document.addEventListener('DOMContentLoaded', function() {
            // Add debug button temporarily
            const debugButton = document.createElement('button');
            debugButton.textContent = 'Test Balance +100';
            debugButton.style.position = 'fixed';
            debugButton.style.top = '10px';
            debugButton.style.right = '10px';
            debugButton.style.zIndex = '1000';
            debugButton.style.padding = '5px 10px';
            debugButton.style.background = 'var(--gold)';
            debugButton.style.color = 'var(--dark-bg)';
            debugButton.style.border = 'none';
            debugButton.style.borderRadius = '5px';
            debugButton.style.cursor = 'pointer';
            debugButton.onclick = simulateBalanceUpdate;
            document.body.appendChild(debugButton);
        });

        // ... (rest of your functions remain exactly the same) ...
    </script>
</body>
</html>