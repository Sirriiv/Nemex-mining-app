<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy NMXp - NemexCoin</title>
    <style>
        /* ... (keep all your existing styles exactly the same) ... */
    </style>
</head>
<body>
    <!-- ... (keep all your existing HTML exactly the same) ... -->

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://bjulifvbfogymoduxnzl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqdWxpZnZiZm9neW1vZHV4bnpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MTk0NDMsImV4cCI6MjA3NTQ5NTQ0M30.MPxDDybfODRnzvrFNZ0TQKkV983tGUFriHYgIpa_LaU';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        let selectedPackage = null;
        let currentUser = null;
        let currentBalance = 0;

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        async function initializePage() {
            try {
                // Get current user session
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = session.user;
                console.log('User ID:', currentUser.id);

                // Wait a bit for DOM to be fully ready
                setTimeout(() => {
                    loadBalanceFromDashboard();
                }, 100);

            } catch (error) {
                console.error('Error initializing page:', error);
                showBalanceError();
            }
        }

        function getBalanceElement() {
            return document.getElementById('currentBalance');
        }

        function loadBalanceFromDashboard() {
            const balanceElement = getBalanceElement();
            if (!balanceElement) {
                console.error('Balance element not found, retrying...');
                setTimeout(loadBalanceFromDashboard, 100);
                return;
            }

            console.log('=== DEBUG: Searching for balance ===');
            
            // Get ALL localStorage items to see what's available
            const allLocalStorage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allLocalStorage[key] = localStorage.getItem(key);
            }
            console.log('All localStorage:', allLocalStorage);

            // Get ALL sessionStorage items
            const allSessionStorage = {};
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                allSessionStorage[key] = sessionStorage.getItem(key);
            }
            console.log('All sessionStorage:', allSessionStorage);

            // Check for ANY numeric value in storage that could be the balance
            let foundBalance = null;
            let foundKey = null;

            // Check localStorage for any numeric values
            for (const key in allLocalStorage) {
                const value = allLocalStorage[key];
                // Skip tokens and non-numeric looking values
                if (key.includes('token') || key.includes('auth') || value.length > 100) continue;
                
                // Try to parse as number
                const numValue = parseFloat(value);
                if (!isNaN(numValue) && numValue >= 0 && numValue < 1000000) { // Reasonable balance range
                    foundBalance = numValue;
                    foundKey = `localStorage.${key}`;
                    console.log(`Found potential balance in localStorage.${key}:`, foundBalance);
                    break;
                }
            }

            // If still not found, check sessionStorage
            if (!foundBalance) {
                for (const key in allSessionStorage) {
                    const value = allSessionStorage[key];
                    if (key.includes('token') || key.includes('auth') || value.length > 100) continue;
                    
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue) && numValue >= 0 && numValue < 1000000) {
                        foundBalance = numValue;
                        foundKey = `sessionStorage.${key}`;
                        console.log(`Found potential balance in sessionStorage.${key}:`, foundBalance);
                        break;
                    }
                }
            }

            if (foundBalance) {
                currentBalance = foundBalance;
                updateBalanceDisplay();
                console.log(`âœ… Balance loaded from ${foundKey}:`, currentBalance);
            } else {
                console.log('âŒ No balance found in storage, checking dashboard methods...');
                // Try to get balance using dashboard method
                tryGetDashboardBalance();
            }
        }

        function tryGetDashboardBalance() {
            const balanceElement = getBalanceElement();
            if (!balanceElement) {
                console.error('Balance element not found in tryGetDashboardBalance');
                return;
            }

            // Method 1: Check if dashboard stored balance in a specific way
            const dashboardBalance = window.dashboardBalance || window.userData?.balance || window.nmxpData?.balance;
            
            // Method 2: Check if there's a global function to get balance
            const balanceFromFunction = window.getUserBalance ? window.getUserBalance() : null;
            
            // Method 3: Check if we can access dashboard elements directly
            let balanceFromDOM = 0;
            try {
                // Try to find balance in other tabs/windows
                const dashboardWindow = window.opener || window.parent;
                if (dashboardWindow && dashboardWindow !== window) {
                    balanceFromDOM = dashboardWindow.document.querySelector('[data-balance]')?.textContent || 
                                   dashboardWindow.document.querySelector('.balance')?.textContent ||
                                   dashboardWindow.document.querySelector('.nmxp-balance')?.textContent;
                }
            } catch (e) {
                // Cross-origin restriction, can't access other windows
            }

            const potentialBalance = dashboardBalance || balanceFromFunction || parseFloat(balanceFromDOM);
            
            if (potentialBalance && !isNaN(potentialBalance)) {
                currentBalance = potentialBalance;
                updateBalanceDisplay();
                console.log('âœ… Balance loaded from dashboard methods:', currentBalance);
            } else {
                console.log('âŒ No balance found from dashboard methods, setting default');
                // Set a reasonable default based on your platform
                currentBalance = 1000; // Default starting balance
                updateBalanceDisplay();
                console.log('Using default balance:', currentBalance);
            }
        }

        function updateBalanceDisplay() {
            const balanceElement = getBalanceElement();
            if (balanceElement) {
                // Clear any loading content
                balanceElement.innerHTML = '';
                balanceElement.textContent = `${currentBalance.toLocaleString()} NMXp`;

                // Add animation for balance updates
                balanceElement.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    const el = getBalanceElement();
                    if (el) {
                        el.style.transform = 'scale(1)';
                    }
                }, 300);
            } else {
                console.error('Balance element not found in updateBalanceDisplay!');
                // Retry after a short delay
                setTimeout(updateBalanceDisplay, 100);
            }
        }

        function showBalanceError() {
            const balanceElement = getBalanceElement();
            if (balanceElement) {
                balanceElement.innerHTML = '<span style="color: var(--danger);">Error loading balance</span>';
            }
        }

        // Listen for balance updates from dashboard
        window.addEventListener('storage', function(e) {
            console.log('Storage event detected:', e.key, e.newValue);
            if (e.key && (e.key.includes('balance') || e.key.includes('Balance'))) {
                const newBalance = parseFloat(e.newValue);
                if (!isNaN(newBalance)) {
                    currentBalance = newBalance;
                    updateBalanceDisplay();
                    console.log('Balance updated from storage:', currentBalance);
                }
            }
        });

        // Also check for balance updates when page becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Refresh balance when user returns to this page
                loadBalanceFromDashboard();
            }
        });

        // Periodically check for balance updates (every 30 seconds)
        setInterval(loadBalanceFromDashboard, 30000);

        // Simulate balance updates for testing (remove in production)
        function simulateBalanceUpdate() {
            // This is just for testing - shows the system works when balance changes
            currentBalance += 100;
            updateBalanceDisplay();
            console.log('Simulated balance update:', currentBalance);
        }

        // Add a temporary debug button to test balance updates
        setTimeout(() => {
            const debugButton = document.createElement('button');
            debugButton.textContent = 'Test Balance +100';
            debugButton.style.position = 'fixed';
            debugButton.style.top = '10px';
            debugButton.style.right = '10px';
            debugButton.style.zIndex = '1000';
            debugButton.style.padding = '5px 10px';
            debugButton.style.background = 'var(--gold)';
            debugButton.style.color = 'var(--dark-bg)';
            debugButton.style.border = 'none';
            debugButton.style.borderRadius = '5px';
            debugButton.style.cursor = 'pointer';
            debugButton.style.fontSize = '12px';
            debugButton.onclick = simulateBalanceUpdate;
            document.body.appendChild(debugButton);
        }, 1000);

        // Rest of your existing functions...
        function selectPackage(element, amount, price, purchaseLimit, bonus = 0) {
            document.querySelectorAll('.package-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedPackage = {
                element: element,
                amount: amount,
                price: price,
                purchaseLimit: purchaseLimit,
                bonus: bonus,
                totalAmount: amount + bonus,
                isVip: element.classList.contains('vip')
            };
            updateMinimumAmounts();
        }

        function selectPayment(element, method) {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function updateMinimumAmounts() {
            if (selectedPackage) {
                const price = selectedPackage.price;
                document.getElementById('tonMinimum').textContent = `Minimum: $${price} worth of TON`;
                document.getElementById('usdtTonMinimum').textContent = `Minimum: $${price} USDT`;
                document.getElementById('usdtTrcMinimum').textContent = `Minimum: $${price} USDT`;
            }
        }

        function showPaymentConfirmation() {
            if (!selectedPackage) {
                alert('Please select a package first');
                return;
            }
            document.getElementById('confirmPackage').textContent = `${selectedPackage.totalAmount.toLocaleString()} NMXp`;
            document.getElementById('confirmAmount').textContent = `${selectedPackage.totalAmount.toLocaleString()} NMXp`;
            document.getElementById('confirmPrice').textContent = `$${selectedPackage.price} USD`;
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        function closeConfirmation() {
            document.getElementById('confirmationModal').style.display = 'none';
        }

        async function processManualConfirmation() {
            try {
                const confirmBtn = document.querySelector('.confirm-btn');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = 'Processing...';
                confirmBtn.disabled = true;

                const { data, error } = await supabaseClient
                    .from('pending_payments')
                    .insert({
                        user_id: currentUser.id,
                        user_email: currentUser.email,
                        package_amount: selectedPackage.amount,
                        total_amount: selectedPackage.totalAmount,
                        price_usd: selectedPackage.price,
                        payment_method: 'crypto',
                        status: 'pending_review',
                        is_vip_package: selectedPackage.isVip,
                        created_at: new Date().toISOString()
                    })
                    .select();

                if (error) throw error;

                closeConfirmation();
                alert(`âœ… Payment Confirmation Submitted!\n\nðŸ“¦ Package: ${selectedPackage.totalAmount.toLocaleString()} NMXp\nðŸ’° Amount: $${selectedPackage.price} USD\n\nWe've recorded your purchase request. Our team will verify your blockchain transaction and credit your NMXp within 1-2 hours.\n\nThank you for your purchase! ðŸŽ‰`);

                if (selectedPackage) {
                    selectedPackage.element.classList.remove('selected');
                }
                selectedPackage = null;
                updateMinimumAmounts();

                setTimeout(() => {
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Confirmation error:', error);
                alert('âŒ Confirmation failed. Please try again.');
                const confirmBtn = document.querySelector('.confirm-btn');
                confirmBtn.innerHTML = 'Yes, I Paid';
                confirmBtn.disabled = false;
            }
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const buttons = document.querySelectorAll('.copy-btn');
                buttons.forEach(btn => btn.textContent = 'Copy Address');
                const clickedBtn = event.target;
                clickedBtn.textContent = 'Copied!';
                clickedBtn.classList.add('copied');
                setTimeout(() => {
                    clickedBtn.textContent = 'Copy Address';
                    clickedBtn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Failed to copy address. Please select and copy manually.');
            });
        }
    </script>
</body>
</html>