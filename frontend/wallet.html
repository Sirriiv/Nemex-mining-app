<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nemex Wallet - Secure TON Wallet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/wallet.js"></script>
    <script src="assets/js/crypto-utils.js"></script>

    <style>
        :root {
            --dark-bg: #0A0A0A;
            --darker-bg: #080808;
            --card-bg: #121212;
            --gold: #D4AF37;
            --gold-light: #E6C158;
            --text: #F5F5F5;
            --text-muted: #AAAAAA;
            --success: #00C851;
            --error: #FF4444;
            --warning: #ffbb33;
            --border-radius: 16px;
            --border-radius-sm: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --bg-secondary: #1a1a1a;
            --border-color: rgba(212, 175, 55, 0.3);
            --muted: #888888;
            --info: #0099CC;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--dark-bg);
            color: var(--text);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding-bottom: 0;
        }

        /* ... (all existing CSS styles remain the same) ... */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            min-width: 120px;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: var(--dark-bg);
            border: 1px solid var(--gold);
        }

        .modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .modal-btn.secondary {
            background: transparent;
            color: var(--gold);
            border: 2px solid var(--gold);
        }

        .modal-btn.secondary:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }

        .password-strength {
            margin-top: 8px;
            font-size: 12px;
            text-align: left;
        }

        .strength-weak { color: var(--error); }
        .strength-medium { color: var(--warning); }
        .strength-strong { color: var(--success); }

        /* Add to your existing styles */

    </style>
</head>
<body>
    <div class="container">
        <!-- ALL EXISTING HTML CODE REMAINS THE SAME UNTIL THE SETTINGS MODAL -->

        <!-- ... (all existing HTML remains the same) ... -->

        <div id="settingsModal" class="modal fullscreen">
            <div class="modal-content">
                <div class="modal-title">Settings</div>

                <div class="wallet-management-section">
                    <div class="wallet-management-header" onclick="toggleWalletManagement()">
                        <div class="wallet-management-title">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Wallet Management
                        </div>
                        <div class="wallet-management-arrow">‚ñº</div>
                    </div>

                    <div class="wallet-management-content" id="walletManagementContent">
                        <div class="wallet-list" id="walletList">
                        </div>

                        <div class="add-wallet-actions">
                            <button class="add-wallet-btn" onclick="showPasswordModalForCreation()">
                                <i class="fas fa-plus-circle"></i>
                                Create New Wallet
                            </button>
                            <button class="add-wallet-btn" onclick="showImportWalletModal()">
                                <i class="fas fa-download"></i>
                                Import Existing Wallet
                            </button>
                        </div>
                    </div>
                </div>

                <!-- üîê UPDATED: View Recovery Phrase now requires password -->
                <div class="settings-option" onclick="showPasswordModalForSeedView()">
                    <div class="settings-option-content">
                        <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                        </svg>
                        <div>View Recovery Phrase</div>
                    </div>
                </div>

                <!-- üîê NEW: Change Encryption Password -->
                <div class="settings-option" onclick="showChangePasswordModal()">
                    <div class="settings-option-content">
                        <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                        </svg>
                        <div>Change Encryption Password</div>
                    </div>
                </div>

                <!-- üîê NEW: Backup Status -->
                <div class="settings-option" onclick="showBackupStatus()">
                    <div class="settings-option-content">
                        <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div>Backup Status</div>
                    </div>
                </div>

                <div class="settings-option" onclick="logout()">
                    <div class="settings-option-content">
                        <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <div>Logout</div>
                    </div>
                </div>

                <div class="security-warning">
                    <strong>üîí Non-Custodial:</strong> You control your keys. We never access your funds.
                </div>

                <button class="close-modal" onclick="closeModal()">Close Settings</button>
            </div>
        </div>

        <!-- ... (all existing HTML remains the same) ... -->

    </div>

    <script>
// =============================================
// üéØ INTEGRATED WALLET FOR LOGGED-IN NEMEX USERS
// =============================================

let walletState = {
    hasWallet: false,
    wallet: null,
    balances: {},
    prices: {},
    isLoading: false,
    currentView: 'wallet',
    currentUser: null
};

let SUPPORTED_TOKENS = [
    {
        symbol: "TON",
        name: "Toncoin",
        balance: 0,
        logo: "https://assets.coingecko.com/coins/images/17980/large/ton_symbol.png", 
        price: 2.5,
        change24h: 0,
        canSend: true,
        isNative: true,
        contract: null
    },
    {
        symbol: "NMX", 
        name: "NemexCoin",
        balance: 0,
        logo: "https://turquoise-obedient-frog-86.mypinata.cloud/ipfs/QmZo4rNnhhpWq6qQBkXBaAGqTdrawEzmW4w4QQsuMSjjW1",
        price: 0.10,
        change24h: 0,
        canSend: true,
        isNative: false,
        contract: "EQBRSrXz-7iYDnFZGhrER2XQL-gBgv1hr3Y8byWsVIye7A9f"
    }
];

// =============================================
// üéØ NEW: PASSWORD MODALS FOR HYBRID SYSTEM
// =============================================

// üîê Password modal for wallet creation
function showPasswordModalForCreation() {
    const modalHtml = `
        <div class="modal-overlay" id="passwordModal">
            <div class="modal-content" style="max-width: 380px; background: var(--card-bg); padding: 24px; border-radius: var(--border-radius);">
                <h3 style="color: var(--gold); margin-bottom: 15px; text-align: center;">üîê Wallet Security</h3>
                <p style="color: var(--muted); margin-bottom: 20px; text-align: center;">
                    Enter your account password to create a secure wallet.
                    <br><small>Your password will encrypt your seed phrase.</small>
                </p>
                
                <div class="form-group">
                    <label class="form-label">Account Password</label>
                    <input type="password" class="form-input" id="walletPassword" 
                           placeholder="Enter your account password" autocomplete="off"
                           oninput="checkPasswordStrength(this.value, 'strengthIndicator')">
                    <div id="strengthIndicator" class="password-strength"></div>
                </div>
                
                <div class="modal-actions">
                    <button class="modal-btn secondary" onclick="closePasswordModal()">Cancel</button>
                    <button class="modal-btn primary" onclick="createWalletWithPassword()">Create Wallet</button>
                </div>
                
                <div style="margin-top: 15px; font-size: 12px; color: var(--muted); text-align: center;">
                    <i class="fas fa-shield-alt"></i> Your password encrypts your seed phrase securely.
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// üîê Password modal for seed phrase viewing
function showPasswordModalForSeedView() {
    if (!walletState.hasWallet) {
        showMessage('‚ùå You need a wallet to view seed phrase', 'error');
        return;
    }
    
    const modalHtml = `
        <div class="modal-overlay" id="seedPasswordModal">
            <div class="modal-content" style="max-width: 380px; background: var(--card-bg); padding: 24px; border-radius: var(--border-radius);">
                <h3 style="color: var(--gold); margin-bottom: 15px; text-align: center;">üîê View Seed Phrase</h3>
                <p style="color: var(--muted); margin-bottom: 20px; text-align: center;">
                    Enter your account password to view your seed phrase.
                </p>
                
                <div class="form-group">
                    <label class="form-label">Account Password</label>
                    <input type="password" class="form-input" id="seedViewPassword" 
                           placeholder="Enter your account password" autocomplete="off">
                </div>
                
                <div class="modal-actions">
                    <button class="modal-btn secondary" onclick="closeSeedPasswordModal()">Cancel</button>
                    <button class="modal-btn primary" onclick="viewSeedPhraseWithPassword()">View Seed</button>
                </div>
                
                <div style="margin-top: 15px; font-size: 12px; color: var(--error); text-align: center;">
                    <i class="fas fa-exclamation-triangle"></i> Never share your seed phrase!
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// üîê NEW: Change encryption password modal
function showChangePasswordModal() {
    const modalHtml = `
        <div class="modal-overlay" id="changePasswordModal">
            <div class="modal-content" style="max-width: 380px; background: var(--card-bg); padding: 24px; border-radius: var(--border-radius);">
                <h3 style="color: var(--gold); margin-bottom: 15px; text-align: center;">üîê Change Encryption Password</h3>
                
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" class="form-input" id="currentPassword" 
                           placeholder="Enter current password" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-input" id="newPassword" 
                           placeholder="Enter new password" autocomplete="off"
                           oninput="checkPasswordStrength(this.value, 'newStrengthIndicator')">
                    <div id="newStrengthIndicator" class="password-strength"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" class="form-input" id="confirmNewPassword" 
                           placeholder="Confirm new password" autocomplete="off">
                </div>
                
                <div class="modal-actions">
                    <button class="modal-btn secondary" onclick="closeChangePasswordModal()">Cancel</button>
                    <button class="modal-btn primary" onclick="changeEncryptionPassword()">Change Password</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// üîê NEW: Backup status modal
async function showBackupStatus() {
    if (!walletState.currentUser?.id) {
        showMessage('‚ùå You need to be logged in', 'error');
        return;
    }
    
    const result = await window.walletManager.getBackupStatus(walletState.currentUser.id);
    
    if (result.success && result.status) {
        const status = result.status;
        const modalHtml = `
            <div class="modal-overlay" id="backupStatusModal">
                <div class="modal-content" style="max-width: 400px; background: var(--card-bg); padding: 24px; border-radius: var(--border-radius);">
                    <h3 style="color: var(--gold); margin-bottom: 15px; text-align: center;">üìä Backup Status</h3>
                    
                    <div style="background: rgba(212, 175, 55, 0.1); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--muted);">Backup Method:</span>
                            <span style="color: var(--gold); font-weight: 600;">${status.backupMethod || 'Unknown'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--muted);">First Viewed:</span>
                            <span style="color: ${status.firstViewed ? 'var(--success)' : 'var(--warning)'};">${status.firstViewed ? 'Yes' : 'No'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--muted);">Can Recover:</span>
                            <span style="color: ${status.canRecover ? 'var(--success)' : 'var(--warning)'};">${status.canRecover ? 'Yes' : 'No'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--muted);">Security Level:</span>
                            <span style="color: var(--gold); font-weight: 600;">${status.securityLevel || 'Unknown'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--muted);">Wallet Age:</span>
                            <span style="color: var(--muted);">${status.walletAge || 'Unknown'}</span>
                        </div>
                    </div>
                    
                    <div style="color: var(--muted); font-size: 14px; text-align: center; margin-bottom: 20px;">
                        ${result.recommendations || ''}
                    </div>
                    
                    <div class="modal-actions">
                        <button class="modal-btn primary" onclick="closeBackupStatusModal()">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    } else {
        showMessage('‚ùå Failed to get backup status: ' + (result.error || 'Unknown error'), 'error');
    }
}

// üîê NEW: Close modal functions
function closePasswordModal() {
    const modal = document.getElementById('passwordModal');
    if (modal) modal.remove();
}

function closeSeedPasswordModal() {
    const modal = document.getElementById('seedPasswordModal');
    if (modal) modal.remove();
}

function closeChangePasswordModal() {
    const modal = document.getElementById('changePasswordModal');
    if (modal) modal.remove();
}

function closeBackupStatusModal() {
    const modal = document.getElementById('backupStatusModal');
    if (modal) modal.remove();
}

// üîê NEW: Create wallet with password
async function createWalletWithPassword() {
    const password = document.getElementById('walletPassword')?.value;
    
    if (!password) {
        showMessage('‚ùå Password is required', 'error');
        return;
    }
    
    if (!walletState.currentUser?.id) {
        showMessage('‚ùå You need to be logged in', 'error');
        return;
    }
    
    try {
        showLoading('Creating secure wallet...');
        
        const result = await window.walletManager.createWallet(
            walletState.currentUser.id, 
            password
        );
        
        if (result.success) {
            closePasswordModal();
            
            // Show seed phrase modal
            showSeedPhraseModal(result.mnemonic);
            
            // Update wallet state
            walletState.hasWallet = true;
            walletState.wallet = result.wallet;
            
            // Show success message
            setTimeout(() => {
                document.body.classList.add('wallet-loaded');
                showWalletInterface();
                loadWalletData();
                showMessage('‚úÖ Wallet created successfully!', 'success');
            }, 1000);
        } else {
            throw new Error(result.error || 'Failed to create wallet');
        }
    } catch (error) {
        console.error('‚ùå Create wallet failed:', error);
        showMessage(`‚ùå ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

// üîê NEW: View seed phrase with password
async function viewSeedPhraseWithPassword() {
    const password = document.getElementById('seedViewPassword')?.value;
    
    if (!password) {
        showMessage('‚ùå Password is required', 'error');
        return;
    }
    
    if (!walletState.currentUser?.id) {
        showMessage('‚ùå You need to be logged in', 'error');
        return;
    }
    
    try {
        showLoading('Verifying password...');
        
        const result = await window.walletManager.viewSeedPhrase(
            walletState.currentUser.id, 
            password
        );
        
        if (result.success) {
            closeSeedPasswordModal();
            showSeedPhraseModal(result.seedPhrase);
        } else {
            throw new Error(result.error || 'Failed to retrieve seed phrase');
        }
    } catch (error) {
        console.error('‚ùå View seed phrase failed:', error);
        showMessage(`‚ùå ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

// üîê NEW: Change encryption password
async function changeEncryptionPassword() {
    const currentPassword = document.getElementById('currentPassword')?.value;
    const newPassword = document.getElementById('newPassword')?.value;
    const confirmPassword = document.getElementById('confirmNewPassword')?.value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showMessage('‚ùå All password fields are required', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showMessage('‚ùå New passwords do not match', 'error');
        return;
    }
    
    if (!walletState.currentUser?.id) {
        showMessage('‚ùå You need to be logged in', 'error');
        return;
    }
    
    try {
        showLoading('Changing encryption password...');
        
        const result = await window.walletManager.changeSeedPassword(
            walletState.currentUser.id,
            currentPassword,
            newPassword
        );
        
        if (result.success) {
            closeChangePasswordModal();
            showMessage('‚úÖ Encryption password changed successfully!', 'success');
        } else {
            throw new Error(result.error || 'Failed to change password');
        }
    } catch (error) {
        console.error('‚ùå Change password failed:', error);
        showMessage(`‚ùå ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

// üîê NEW: Password strength checker
function checkPasswordStrength(password, indicatorId) {
    const indicator = document.getElementById(indicatorId);
    if (!password || !indicator) return;
    
    const result = window.walletManager.validatePasswordStrength(password);
    indicator.textContent = result.message;
    indicator.className = 'password-strength ' + 
        (result.strength === 'strong' ? 'strength-strong' : 
         result.strength === 'medium' ? 'strength-medium' : 'strength-weak');
}

// üîê UPDATED: Show seed phrase modal
function showSeedPhraseModal(seedPhrase) {
    const words = seedPhrase.split(' ');
    const mnemonicWords = document.getElementById('viewSeedWords');
    
    if (mnemonicWords) {
        mnemonicWords.innerHTML = words.map((word, index) => `
            <div class="mnemonic-word">
                <span class="word-index">${index + 1}.</span>
                <span class="word-text">${word}</span>
            </div>
        `).join('');
    }
    
    document.getElementById('viewSeedModal').style.display = 'flex';
}

// =============================================
// üéØ INITIALIZATION (Updated for Hybrid System)
// =============================================

async function initWallet() {
    console.log('üîÑ Initializing Nemex Hybrid wallet...');

    try {
        // Initialize wallet manager
        const result = await window.walletManager.initialize();
        
        if (result.success) {
            if (result.hasWallet) {
                // User has a wallet - show wallet interface
                walletState.hasWallet = true;
                walletState.wallet = result.wallet;
                walletState.currentUser = result.user;
                console.log('‚úÖ Wallet loaded for user:', result.wallet.address);
                
                document.body.classList.add('wallet-loaded');
                showWalletInterface();
                await loadWalletData();
            } else {
                // User doesn't have a wallet - show welcome screen
                console.log('‚ÑπÔ∏è No wallet found for user - showing welcome screen');
                walletState.currentUser = result.user;
                document.body.classList.remove('wallet-loaded');
                showWelcomeScreen();
            }
        } else {
            if (result.requiresLogin) {
                console.log('‚ö†Ô∏è User not logged in - redirecting to login');
                showLoginRequiredMessage();
            } else {
                console.error('‚ùå Wallet init failed:', result.error);
                showErrorMessage('Failed to load wallet');
            }
        }
    } catch (error) {
        console.error('‚ùå Wallet initialization failed:', error);
        showErrorMessage('Wallet system error');
    }
}

// =============================================
// üéØ WALLET CREATION & IMPORT (Updated)
// =============================================

// üîê UPDATED: Show create wallet button now triggers password modal
function showCreateWalletModal() {
    showPasswordModalForCreation();
}

async function importWalletFromModal() {
    const mnemonicInput = document.getElementById('importMnemonic');
    const statusElement = document.getElementById('importWalletStatus');
    const importBtn = document.getElementById('importWalletBtn');

    if (!walletState.currentUser?.id) {
        showMessage('‚ùå You need to be logged in to import a wallet', 'error');
        return;
    }

    try {
        const mnemonic = mnemonicInput.value.trim();
        if (!mnemonic) {
            throw new Error('Please enter your recovery phrase');
        }

        const words = mnemonic.split(' ').filter(word => word.trim().length > 0);
        if (words.length !== 12 && words.length !== 24) {
            throw new Error('Seed phrase must be 12 or 24 words');
        }

        importBtn.innerHTML = '<div class="loading" style="margin-right: 8px;"></div> Importing...';
        importBtn.disabled = true;

        statusElement.innerHTML = '<div class="status-loading">üîÑ Importing wallet...</div>';

        // Import wallet for current user
        const result = await window.walletManager.importWallet(walletState.currentUser.id, mnemonic);

        if (result.success && result.wallet) {
            console.log('‚úÖ Wallet imported for user:', result.wallet.address);
            
            // Update wallet state
            walletState.hasWallet = true;
            walletState.wallet = result.wallet;
            
            // Switch to wallet interface
            document.body.classList.add('wallet-loaded');
            showWalletInterface();
            await loadWalletData();
            closeModal();
            
            statusElement.innerHTML = '<div class="status-success">‚úÖ Wallet imported successfully!</div>';
            showMessage('‚úÖ Wallet imported successfully!', 'success');
        } else {
            throw new Error(result.error || 'Failed to import wallet');
        }
    } catch (error) {
        console.error('‚ùå Import wallet failed:', error);
        statusElement.innerHTML = `<div class="status-error">‚ùå ${error.message}</div>`;
        importBtn.innerHTML = 'Import Wallet';
        importBtn.disabled = false;
    }
}

// =============================================
// üéØ WALLET OPERATIONS
// =============================================

async function loadWalletData() {
    if (!walletState.hasWallet || !walletState.wallet) return;

    try {
        // Load TON balance
        const balanceResult = await window.walletManager.getBalance(walletState.wallet.address);
        if (balanceResult.success) {
            SUPPORTED_TOKENS[0].balance = balanceResult.balance;
        }

        // Load prices
        const priceResult = await window.walletManager.getPrices();
        if (priceResult.success && priceResult.prices) {
            SUPPORTED_TOKENS[0].price = priceResult.prices.TON?.price || 2.5;
            SUPPORTED_TOKENS[0].change24h = priceResult.prices.TON?.change24h || 0;
            SUPPORTED_TOKENS[1].price = priceResult.prices.NMX?.price || 0.10;
            SUPPORTED_TOKENS[1].change24h = priceResult.prices.NMX?.change24h || 0;
        }

        updateWalletDisplay();
    } catch (error) {
        console.error('‚ùå Load wallet data failed:', error);
    }
}

async function sendTransaction() {
    if (!walletState.currentUser?.id || !walletState.wallet) {
        showMessage('‚ùå You need a wallet to send transactions', 'error');
        return;
    }

    const toAddress = document.getElementById('sendToAddress')?.value.trim();
    const amount = document.getElementById('sendAmount')?.value;
    const memo = document.getElementById('sendMemo')?.value.trim();
    const selectedToken = document.getElementById('selectedTokenSymbol')?.textContent || 'TON';

    if (!toAddress || !amount) {
        showMessage('‚ùå Please fill all required fields', 'error');
        return;
    }

    if (parseFloat(amount) <= 0) {
        showMessage('‚ùå Amount must be greater than 0', 'error');
        return;
    }

    try {
        showLoading('Sending transaction...');
        
        if (selectedToken === 'TON') {
            const result = await window.walletManager.sendTON(
                walletState.currentUser.id,
                walletState.wallet.address,
                toAddress,
                amount,
                memo
            );
            
            if (result.success) {
                console.log('‚úÖ Transaction sent:', result.transaction?.hash);
                showMessage(`‚úÖ Sent ${amount} TON successfully!`, 'success');
                closeModal();
                
                // Refresh balances
                await loadWalletData();
            } else {
                throw new Error(result.error || 'Transaction failed');
            }
        } else if (selectedToken === 'NMX') {
            showMessage('‚ö†Ô∏è NMX token sending not implemented yet', 'warning');
        }
    } catch (error) {
        console.error('‚ùå Send transaction failed:', error);
        showMessage(`‚ùå ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

// =============================================
// üéØ UTILITY FUNCTIONS
// =============================================

function showMessage(message, type = 'info') {
    console.log(`üì¢ ${message}`);
    
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 10000;
        max-width: 90%;
        text-align: center;
    `;
    
    if (type === 'error') {
        messageDiv.style.background = 'var(--error)';
        messageDiv.style.color = 'white';
        messageDiv.innerHTML = `‚ùå ${message}`;
    } else if (type === 'success') {
        messageDiv.style.background = 'var(--success)';
        messageDiv.style.color = 'white';
        messageDiv.innerHTML = `‚úÖ ${message}`;
    } else if (type === 'warning') {
        messageDiv.style.background = 'var(--warning)';
        messageDiv.style.color = 'var(--dark-bg)';
        messageDiv.innerHTML = `‚ö†Ô∏è ${message}`;
    } else {
        messageDiv.style.background = 'var(--gold)';
        messageDiv.style.color = 'var(--dark-bg)';
        messageDiv.innerHTML = `‚ÑπÔ∏è ${message}`;
    }
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 3000);
}

function showErrorMessage(message) {
    showMessage(message, 'error');
}

function showLoading(message) {
    walletState.isLoading = true;
    const loadingEl = document.getElementById('loadingOverlay');
    if (loadingEl) {
        loadingEl.style.display = 'flex';
    }
}

function hideLoading() {
    walletState.isLoading = false;
    const loadingEl = document.getElementById('loadingOverlay');
    if (loadingEl) {
        loadingEl.style.display = 'none';
    }
}

// =============================================
// üöÄ INITIALIZE ON PAGE LOAD
// =============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Nemex Hybrid Wallet page loaded - initializing...');
    
    // Initialize wallet after page loads
    setTimeout(() => {
        initWallet();
    }, 500);
});

console.log('‚úÖ Nemex Hybrid Wallet System loaded');
</script>
</body>
</html>