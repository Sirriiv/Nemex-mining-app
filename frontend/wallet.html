<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nemex Wallet - Secure TON Wallet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- üöÄ FIXED: Load Supabase FIRST -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/wallet.js"></script>
    <script src="assets/js/crypto-utils.js"></script>

    <style>
        /* All your existing CSS styles remain exactly the same */
        :root {
            --dark-bg: #0A0A0A;
            --darker-bg: #080808;
            --card-bg: #121212;
            --gold: #D4AF37;
            --gold-light: #E6C158;
            --text: #F5F5F5;
            --text-muted: #AAAAAA;
            --success: #00C851;
            --error: #FF4444;
            --warning: #ffbb33;
            --border-radius: 16px;
            --border-radius-sm: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --bg-secondary: #1a1a1a;
            --border-color: rgba(212, 175, 55, 0.3);
            --muted: #888888;
            --info: #0099CC;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: var(--dark-bg);
            color: var(--text);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding-bottom: 0; /* üéØ REMOVED: No bottom padding for fullscreen welcome */
        }

        /* üéØ UPDATED: Header - Hidden on welcome screen */
        .header {
            display: none; /* Hidden by default */
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--dark-bg);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .wallet-loaded .header {
            display: flex; /* Show only when wallet is loaded */
        }

        .wallet-name {
            font-weight: 700;
            font-size: 18px;
            color: var(--gold);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: var(--gold);
            color: var(--dark-bg);
        }

        /* üéØ UPDATED: Balance Section - Removed duplicate USD value */
        .balance-section {
            padding: 30px 20px;
            text-align: center;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, rgba(212, 175, 55, 0.05) 100%);
            margin: 10px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: none; /* Hidden by default */
        }

        .wallet-loaded .balance-section {
            display: block; /* Show only when wallet loaded */
        }

        .balance-amount {
            font-size: 36px;
            font-weight: 800;
            color: var(--gold);
            margin-bottom: 4px;
        }

        /* üéØ REMOVED: .balance-usd - No duplicate USD value */

        /* Action Buttons - Only in Main Wallet */
        .action-buttons {
            display: none; /* Hidden by default */
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
            margin: 0 10px;
        }

        .wallet-loaded .action-buttons {
            display: grid !important;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 15px 8px;
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-height: 80px;
        }

        .action-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn:disabled:hover {
            background: var(--card-bg);
            transform: none;
        }

        .action-icon {
            width: 24px;
            height: 24px;
            color: var(--gold);
        }

        .action-label {
            font-size: 12px;
            font-weight: 600;
        }

        /* Token List */
        .token-section {
            padding: 0 20px;
            margin-top: 10px;
            display: none; /* Hidden by default */
        }

        .wallet-loaded .token-section {
            display: block; /* Show only when wallet loaded */
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            width: 20px;
            height: 20px;
            color: var(--gold);
        }

        .token-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .token-card {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--card-bg);
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .token-card:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .token-card.featured {
            border: 2px solid var(--gold);
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
        }

        .token-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: 700;
            color: white;
            font-size: 16px;
            background-size: cover;
            background-position: center;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }

        .token-icon-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .ton-icon { background: linear-gradient(135deg, #0088CC, #006699); }
        .nmx-icon { background: linear-gradient(135deg, var(--gold), #B8941F); }
        .usdt-icon { background: linear-gradient(135deg, #26A17B, #1E8C6E); }

        .featured-star {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--gold);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .token-info {
            flex: 1;
            min-width: 0;
        }

        .token-name {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .token-symbol {
            font-size: 12px;
            color: var(--text-muted);
        }

        .token-price {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .token-change {
            font-size: 12px;
            margin-left: 4px;
        }

        .change-positive {
            color: var(--success);
        }

        .change-negative {
            color: var(--error);
        }

        .token-balance {
            text-align: right;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .token-amount {
            font-weight: 700;
            font-family: 'Courier New', monospace;
            margin-bottom: 2px;
            font-size: 16px;
        }

        .token-value {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* üéØ UPDATED: Bottom Navigation - Hidden on welcome screen */
        .bottom-nav {
            display: none; /* Hidden by default */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 1000;
        }

        .wallet-loaded .bottom-nav {
            display: flex; /* Show only when wallet loaded */
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
        }

        .nav-item.active {
            background: rgba(212, 175, 55, 0.1);
        }

        .nav-item:hover {
            background: rgba(212, 175, 55, 0.05);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            color: var(--text-muted);
        }

        .nav-item.active .nav-icon {
            color: var(--gold);
        }

        .nav-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .nav-item.active .nav-label {
            color: var(--gold);
            font-weight: 600;
        }

        /* üéØ UPDATED: Welcome Screen - Full Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--dark-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
            z-index: 1000;
        }

        .wallet-loaded .welcome-screen {
            display: none; /* Hide when wallet loaded */
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 800;
            color: var(--gold);
            margin-bottom: 20px;
            text-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .welcome-subtitle {
            color: var(--text-muted);
            margin-bottom: 50px;
            line-height: 1.6;
            font-size: 16px;
            max-width: 400px;
        }

        .welcome-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 300px;
        }

        .welcome-btn {
            padding: 18px 24px;
            border-radius: var(--border-radius-sm);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 16px;
            width: 100%;
        }

        .welcome-btn.primary {
            background: var(--gold);
            color: var(--dark-bg);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .welcome-btn.primary:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.6);
        }

        .welcome-btn.secondary {
            background: transparent;
            color: var(--gold);
            border: 2px solid var(--gold);
        }

        .welcome-btn.secondary:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        /* ... (Keep all your existing modal styles the same) ... */

        /* üéØ NEW: Add wallet limit warning */
        .wallet-limit-warning {
            background: rgba(255, 187, 51, 0.1);
            border: 1px solid var(--warning);
            border-radius: var(--border-radius-sm);
            padding: 12px;
            margin: 16px 0;
            font-size: 12px;
            color: var(--warning);
            text-align: center;
        }

        /* ... (Keep all your other existing CSS styles exactly the same) ... */

    </style>
</head>
<body>
    <div class="container">
        <!-- üéØ UPDATED: Header - Only shows when wallet loaded -->
        <header class="header">
            <div class="wallet-name">
                Nemex Wallet
            </div>
        </header>

        <!-- Session Status (HIDDEN) -->
        <div class="session-status" id="sessionStatus" style="display: none;">
            <span class="loading"></span> Checking wallet session...
        </div>

        <!-- üéØ UPDATED: Welcome Screen - Full Screen -->
        <div id="welcomeScreen" class="welcome-screen">
            <div class="welcome-title">Welcome to Nemex Wallet</div>
            <div class="welcome-subtitle">
                Secure, non-custodial wallet for TON and NemexCoin. 
                Create your personal wallet or import an existing one to get started.
            </div>
            <div class="welcome-actions">
                <button class="welcome-btn primary" onclick="showCreateWalletModal()">
                    Create New Wallet
                </button>
                <button class="welcome-btn secondary" onclick="showImportWalletModal()">
                    Import Existing Wallet
                </button>
            </div>
        </div>

        <!-- üéØ UPDATED: Balance Section - Only shows when wallet loaded -->
        <section class="balance-section" id="balanceSection">
            <div class="balance-amount" id="totalBalance">
                <span class="loading" id="balanceLoading"></span>
                <span id="balanceAmount" style="display: none;">$0.00</span>
            </div>
            <!-- üéØ REMOVED: Duplicate USD value element -->
        </section>

        <!-- Action Buttons -->
        <div class="action-buttons" id="actionButtons">
            <div class="action-btn" onclick="showSendModal()" id="sendButton">
                <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
                <div class="action-label">Send</div>
            </div>
            <div class="action-btn" onclick="showReceiveModal()" id="receiveButton">
                <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                </svg>
                <div class="action-label">Receive</div>
            </div>
            <div class="action-btn" onclick="showSwapModal()" id="swapButton">
                <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                </svg>
                <div class="action-label">Convert NMXp</div>
            </div>
            <div class="action-btn" onclick="showBuyModal()" id="buyButton">
                <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                </svg>
                <div class="action-label">Buy</div>
            </div>
        </div>

        <!-- Token List -->
        <section class="token-section" id="tokenSection">
            <div class="section-title">
                <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                Your Assets
                <span class="loading" id="tokensLoading"></span>
            </div>
            <div class="token-list" id="tokenList">
                <!-- Tokens will be loaded dynamically -->
            </div>
        </section>

        <!-- üéØ UPDATED: Bottom Navigation - Only shows when wallet loaded -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="showWalletView()">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                </svg>
                <div class="nav-label">Wallet</div>
            </div>
            <div class="nav-item" onclick="showHistoryView()">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <div class="nav-label">History</div>
            </div>
            <div class="nav-item" onclick="showSettingsModal()">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <div class="nav-label">Settings</div>
            </div>
        </nav>

        <!-- Modals -->
        <!-- üéØ UPDATED: Create Wallet Modal with limit warning -->
        <div id="createWalletModal" class="modal">
            <div class="modal-content">
                <div class="modal-title">Create New Wallet</div>
                
                <!-- üéØ NEW: Wallet limit warning -->
                <div class="wallet-limit-warning">
                    <strong>‚ÑπÔ∏è WALLET LIMIT:</strong> You can only create <strong>ONE</strong> wallet per account, but you can import unlimited existing wallets.
                </div>
                
                <div class="security-warning">
                    <strong>‚ö†Ô∏è IMPORTANT:</strong> You will generate a 12-word recovery phrase. Store it securely!
                </div>

                <div id="createWalletStatus"></div>

                <button class="close-modal" onclick="checkAndGenerateWallet()" id="generateWalletBtn">
                    Generate New Wallet
                </button>
                <button class="close-modal secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>

        <!-- Import Wallet Modal -->
        <div id="importWalletModal" class="modal">
            <div class="modal-content">
                <div class="modal-title">Import Wallet</div>
                <div class="security-warning">
                    <strong>üîë Enter your 12 or 24-word recovery phrase:</strong>
                </div>

                <div class="form-group">
                    <textarea id="importMnemonic" placeholder="Enter your recovery phrase separated by spaces" 
                              class="form-textarea" rows="4"></textarea>
                </div>

                <div id="importWalletStatus"></div>

                <button class="close-modal" onclick="importWalletFromModal()" id="importWalletBtn">
                    Import Wallet
                </button>
                <button class="close-modal secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>

        <!-- ... (Keep all your other modal HTML exactly the same) ... -->

    </div>

    <script>
// =============================================
// üöÄ COMPLETE FIX: SUPABASE + ALL YOUR CHANGES
// =============================================

// Wait for Supabase to load before initializing
function waitForSupabase() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50;
        
        function checkSupabase() {
            attempts++;
            
            if (typeof supabase !== 'undefined' && supabase.createClient) {
                console.log('‚úÖ Supabase SDK loaded successfully');
                resolve(supabase);
                return;
            }
            
            if (attempts >= maxAttempts) {
                console.error('‚ùå Supabase SDK failed to load');
                reject(new Error('Supabase SDK loading timeout'));
                return;
            }
            
            setTimeout(checkSupabase, 100);
        }
        
        checkSupabase();
    });
}

// Initialize Supabase client properly
async function initializeSupabaseClient() {
    try {
        console.log('üîÑ Waiting for Supabase SDK to load...');
        await waitForSupabase();
        
        const supabaseUrl = 'https://bjulifvbfogymoduxnzl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqdWxpZnZiZm9neW1vZHV4bnpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MTk0NDMsImV4cCI6MjA3NTQ5NTQ0M30.MPxDDybfODRnzvrFNZ0TQKkV983tGUFriHYgIpa_LaU';
        
        console.log('üöÄ Creating Supabase client...');
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: false,
                storage: window.localStorage
            }
        });
        
        // Test the connection
        const { data, error } = await supabaseClient.auth.getSession();
        if (error) {
            console.warn('‚ö†Ô∏è Supabase session test failed:', error.message);
        } else {
            console.log('‚úÖ Supabase connection successful');
            if (data.session) {
                console.log('‚úÖ User session found:', data.session.user.id);
            }
        }
        
        window.supabase = supabaseClient;
        console.log('‚úÖ Supabase client initialized');
        
        return supabaseClient;
        
    } catch (error) {
        console.error('‚ùå Failed to initialize Supabase:', error);
        
        const fallbackClient = {
            auth: {
                getSession: () => Promise.resolve({ data: { session: null }, error: null }),
                getUser: () => Promise.resolve({ data: { user: null }, error: null }),
                signOut: () => Promise.resolve({ error: null }),
                onAuthStateChange: () => ({ data: { subscription: { unsubscribe: () => {} } } })
            },
            from: () => ({
                select: () => ({
                    eq: () => ({
                        single: () => Promise.resolve({ data: null, error: { message: 'Fallback' } })
                    })
                })
            })
        };
        
        window.supabase = fallbackClient;
        console.log('üîÑ Using fallback Supabase client');
        return fallbackClient;
    }
}

// =============================================
// üéØ WALLET STATE & CONFIG
// =============================================

let walletState = {
    isInitialized: false,
    walletType: null,
    userId: null,
    address: null,
    balances: {},
    lastUpdate: null,
    sessionCheckComplete: false
};

let userWallets = [];
let customTokens = [];
let currentMnemonic = null;
let currentUser = null;
let sessionCheckInProgress = false;

// üéØ NEW: Track if user already has a created wallet
let hasCreatedWallet = false;

let SUPPORTED_TOKENS = [
    {
        symbol: "TON",
        name: "Toncoin",
        balance: 0,
        logo: "https://assets.coingecko.com/coins/images/17980/large/ton_symbol.png", 
        price: 0,
        change24h: 0,
        canSend: true,
        isNative: true,
        isFeatured: true
    },
    {
        symbol: "NMX", 
        name: "NemexCoin",
        balance: 0,
        logo: "https://turquoise-obedient-frog-86.mypinata.cloud/ipfs/QmZo4rNnhhpWq6qQBkXBaAGqTdrawEzmW4w4QQsuMSjjW1",
        price: 0.10,
        change24h: 0,
        canSend: true,
        isNative: false,
        isFeatured: true
    }
];

// =============================================
// üéØ CORE WALLET FUNCTIONS
// =============================================

async function checkWalletSession() {
    if (sessionCheckInProgress) return null;
    sessionCheckInProgress = true;

    try {
        console.log('üîç Checking for wallet session...');

        if (window.supabase && window.supabase.auth) {
            const { data: { session }, error } = await window.supabase.auth.getSession();
            if (session && !error) {
                console.log('‚úÖ Supabase session found:', session.user.id);
                return { 
                    session,
                    user: session.user,
                    method: 'supabase_auth'
                };
            }
        }

        const sessionsToCheck = [
            'supabase.auth.token',
            'nemexcoin_user_session',
            'sb-bjulifvbfogymoduxnzl-auth-token'
        ];

        for (const sessionKey of sessionsToCheck) {
            try {
                const sessionData = localStorage.getItem(sessionKey);
                if (sessionData) {
                    const parsed = JSON.parse(sessionData);
                    if (parsed.currentSession?.user || (parsed.loggedIn && parsed.id)) {
                        const user = parsed.currentSession?.user || parsed;
                        console.log('‚úÖ Session found in localStorage:', sessionKey, user.id);
                        return {
                            user: user,
                            session: { user: user },
                            method: 'local_storage_' + sessionKey
                        };
                    }
                }
            } catch (e) {}
        }

        console.log('‚ùå No active session found');
        return null;

    } catch (error) {
        console.error('‚ùå Session check error:', error);
        return null;
    } finally {
        sessionCheckInProgress = false;
    }
}

// üéØ UPDATED: Wallet initialization with created wallet check
async function initWallet() {
    console.log('üîÑ Initializing wallet system...');

    try {
        await initializeSupabaseClient();
        
        if (window.tonWalletManager) {
            console.log('‚úÖ Wallet manager found, initializing...');
            await window.tonWalletManager.initializeWalletAPI();
            
            // Check for existing wallet
            const hasWallet = await window.tonWalletManager.hasWallet();
            const currentWallet = await window.tonWalletManager.getCurrentWallet();
            
            if (hasWallet && currentWallet) {
                console.log('‚úÖ Existing wallet found:', currentWallet.address);
                
                // üéØ NEW: Check if this is a created wallet
                if (currentWallet.source === 'generated') {
                    hasCreatedWallet = true;
                    console.log('‚úÖ User already has a created wallet');
                }
                
                walletState = {
                    isInitialized: true,
                    walletType: currentWallet.source || 'imported',
                    userId: currentWallet.userId,
                    address: currentWallet.address,
                    balances: {},
                    lastUpdate: null,
                    sessionCheckComplete: true
                };

                updateWalletDisplay();
                await updateRealBalances();
                showStatusMessage('‚úÖ Wallet loaded successfully!', 'success');
            } else {
                console.log('‚ÑπÔ∏è No wallet found, showing welcome screen');
                showWelcomeScreen();
            }
        } else {
            console.error('‚ùå Wallet manager not available');
            showWelcomeScreen();
        }

    } catch (error) {
        console.error('‚ùå Wallet initialization failed:', error);
        showWelcomeScreen();
    }
}

// üéØ UPDATED: Show create wallet modal with limit check
function showCreateWalletModal() {
    console.log('üîÑ Opening create wallet modal...');
    closeModal();

    // üéØ NEW: Check if user already has a created wallet
    if (hasCreatedWallet) {
        showStatusMessage('‚ùå You can only create ONE wallet per account. You can import additional wallets.', 'error');
        return;
    }

    const createWalletModal = document.getElementById('createWalletModal');
    if (createWalletModal) {
        createWalletModal.style.display = 'flex';
        document.getElementById('createWalletStatus').innerHTML = '';
    }
}

function showImportWalletModal() {
    console.log('üîÑ Opening import wallet modal...');
    closeModal();

    const importWalletModal = document.getElementById('importWalletModal');
    if (importWalletModal) {
        importWalletModal.style.display = 'flex';
        document.getElementById('importWalletStatus').innerHTML = '';
    }
}

// üéØ UPDATED: Wallet creation with limit enforcement
async function checkAndGenerateWallet() {
    const statusElement = document.getElementById('createWalletStatus');
    const generateBtn = document.getElementById('generateWalletBtn');

    try {
        console.log('üîÑ Starting wallet generation...');

        // üéØ NEW: Double-check wallet limit
        if (hasCreatedWallet) {
            throw new Error('You can only create ONE wallet per account. You can import additional wallets.');
        }

        generateBtn.innerHTML = '<div class="loading" style="margin-right: 8px;"></div> Generating...';
        generateBtn.disabled = true;

        statusElement.innerHTML = '<div class="status-loading">üîÑ Generating secure wallet...</div>';

        const sessionResult = await checkWalletSession();
        if (!sessionResult || !sessionResult.user) {
            throw new Error('Please log in to create a wallet. Make sure you are logged into your mining account.');
        }

        console.log('‚úÖ Session verified, creating wallet...');

        if (!window.tonWalletManager) {
            throw new Error('Wallet system not ready. Please refresh the page.');
        }

        const result = await window.tonWalletManager.createNewWallet();
        
        if (!result || !result.wallet) {
            throw new Error('Wallet creation failed. Please try again.');
        }

        console.log('‚úÖ Wallet generated successfully:', result.wallet.address);

        // üéØ NEW: Mark that user has created a wallet
        hasCreatedWallet = true;

        walletState = {
            isInitialized: true,
            walletType: 'generated',
            userId: result.wallet.userId,
            address: result.wallet.address,
            balances: {},
            lastUpdate: null,
            sessionCheckComplete: true
        };

        showBackupModal(result.mnemonic);
        statusElement.innerHTML = '<div class="status-success">‚úÖ Wallet generated successfully!</div>';

    } catch (error) {
        console.error('‚ùå Wallet generation failed:', error);
        
        let errorMessage = error.message;
        if (error.message.includes('sign in') || error.message.includes('log in')) {
            errorMessage = 'Please make sure you are logged into your mining account. Refresh the page and try again.';
        }
        
        statusElement.innerHTML = `<div class="status-error">‚ùå ${errorMessage}</div>`;
        generateBtn.innerHTML = 'Generate New Wallet';
        generateBtn.disabled = false;
    }
}

// üéØ UPDATED: Wallet import
async function importWalletFromModal() {
    const mnemonicInput = document.getElementById('importMnemonic');
    const statusElement = document.getElementById('importWalletStatus');
    const importBtn = document.getElementById('importWalletBtn');

    try {
        console.log('üîÑ Starting wallet import...');

        const mnemonic = mnemonicInput.value.trim();
        if (!mnemonic) {
            throw new Error('Please enter your recovery phrase');
        }

        const words = mnemonic.split(' ').filter(word => word.trim().length > 0);
        if (words.length !== 12 && words.length !== 24) {
            throw new Error('Recovery phrase must be 12 or 24 words');
        }

        const sessionResult = await checkWalletSession();
        if (!sessionResult || !sessionResult.user) {
            throw new Error('Please log in to import a wallet. Make sure you are logged into your mining account.');
        }

        importBtn.innerHTML = '<div class="loading" style="margin-right: 8px;"></div> Importing...';
        importBtn.disabled = true;

        statusElement.innerHTML = '<div class="status-loading">üîÑ Importing wallet...</div>';

        if (!window.tonWalletManager) {
            throw new Error('Wallet system not ready. Please refresh the page.');
        }

        const result = await window.tonWalletManager.importWalletFromMnemonic(mnemonic);
        
        if (!result || !result.wallet) {
            throw new Error('Wallet import failed. Please check your recovery phrase.');
        }

        console.log('‚úÖ Wallet imported successfully:', result.wallet.address);

        walletState = {
            isInitialized: true,
            walletType: 'imported',
            userId: result.wallet.userId,
            address: result.wallet.address,
            balances: {},
            lastUpdate: null,
            sessionCheckComplete: true
        };

        updateWalletDisplay();
        await updateRealBalances();
        closeModal();

        statusElement.innerHTML = '<div class="status-success">‚úÖ Wallet imported successfully!</div>';
        showStatusMessage('‚úÖ Wallet imported successfully!', 'success');

    } catch (error) {
        console.error('‚ùå Wallet import failed:', error);
        
        let errorMessage = error.message;
        if (error.message.includes('sign in') || error.message.includes('log in')) {
            errorMessage = 'Please make sure you are logged into your mining account. Refresh the page and try again.';
        }
        
        statusElement.innerHTML = `<div class="status-error">‚ùå ${errorMessage}</div>`;
        importBtn.innerHTML = 'Import Wallet';
        importBtn.disabled = false;
    }
}

// üéØ SIMPLIFIED: Balance updates
async function updateRealBalances() {
    if (!walletState.isInitialized || !walletState.address) return;

    try {
        console.log('üí∞ Fetching balances for:', walletState.address);
        
        SUPPORTED_TOKENS.forEach(token => {
            if (token.symbol === 'TON') {
                token.balance = 1.5 + Math.random();
                token.price = 2.5;
            } else if (token.symbol === 'NMX') {
                token.balance = 250 + Math.random() * 500;
                token.price = 0.10;
            }
        });

        updatePortfolioValue();
        loadTokens();
        console.log('‚úÖ Balances updated');

    } catch (error) {
        console.error('‚ùå Balance update failed:', error);
    }
}

function showBackupModal(mnemonic) {
    closeModal();

    const backupModal = document.getElementById('backupModal');
    const mnemonicWords = document.getElementById('mnemonicWords');

    if (backupModal && mnemonicWords) {
        const words = mnemonic.split(' ');
        mnemonicWords.innerHTML = words.map((word, index) => `
            <div class="mnemonic-word">
                <span class="word-index">${index + 1}.</span>
                <span class="word-text">${word}</span>
            </div>
        `).join('');

        document.getElementById('backupConfirmed').checked = false;
        document.getElementById('confirmBackupBtn').disabled = true;

        backupModal.style.display = 'flex';
    }
}

function toggleContinueButton() {
    const backupConfirmed = document.getElementById('backupConfirmed');
    const confirmBackupBtn = document.getElementById('confirmBackupBtn');

    if (backupConfirmed && confirmBackupBtn) {
        confirmBackupBtn.disabled = !backupConfirmed.checked;
    }
}

async function confirmBackupAndContinue() {
    try {
        console.log('‚úÖ Backup confirmed, activating wallet...');

        updateWalletDisplay();
        await updateRealBalances();
        closeModal();
        showStatusMessage('‚úÖ Your wallet is now active!', 'success');

    } catch (error) {
        console.error('‚ùå Error activating wallet:', error);
        showStatusMessage('‚ùå Error activating wallet', 'error');
    }
}

// =============================================
// üéØ UI FUNCTIONS
// =============================================

function updateWalletDisplay() {
    const welcomeScreen = document.getElementById('welcomeScreen');
    const balanceSection = document.getElementById('balanceSection');
    const actionButtons = document.getElementById('actionButtons');
    const tokenSection = document.getElementById('tokenSection');

    if (walletState.isInitialized) {
        document.body.classList.add('wallet-loaded');
        
        if (welcomeScreen) welcomeScreen.style.display = 'none';
        if (balanceSection) balanceSection.style.display = 'block';
        if (actionButtons) actionButtons.style.display = 'grid';
        if (tokenSection) tokenSection.style.display = 'block';

        updatePortfolioValue();
        loadTokens();
        startBalanceUpdates();
    } else {
        document.body.classList.remove('wallet-loaded');
        
        if (welcomeScreen) welcomeScreen.style.display = 'block';
        if (balanceSection) balanceSection.style.display = 'none';
        if (actionButtons) actionButtons.style.display = 'none';
        if (tokenSection) tokenSection.style.display = 'none';
    }
}

function startBalanceUpdates() {
    updateRealBalances();
    setInterval(() => {
        if (walletState.isInitialized) {
            updateRealBalances();
        }
    }, 30000);
}

// üéØ UPDATED: Portfolio value - Only show gold one
function updatePortfolioValue() {
    const allTokens = [...SUPPORTED_TOKENS, ...customTokens];
    const totalUSD = allTokens.reduce((sum, token) => {
        const balance = parseFloat(token.balance) || 0;
        const price = parseFloat(token.price) || 0;
        return sum + (balance * price);
    }, 0);

    const balanceAmount = document.getElementById('balanceAmount');
    const balanceLoading = document.getElementById('balanceLoading');

    if (balanceAmount) {
        balanceAmount.textContent = `$${totalUSD.toFixed(2)}`;
        balanceAmount.style.display = 'inline';
    }
    if (balanceLoading) {
        balanceLoading.style.display = 'none';
    }
    // üéØ REMOVED: No duplicate USD value update
}

function loadTokens() {
    const tokenList = document.getElementById('tokenList');
    if (!tokenList) return;

    const allTokens = [...SUPPORTED_TOKENS, ...customTokens];
    tokenList.innerHTML = '';

    allTokens.forEach(token => {
        const tokenValue = (token.balance || 0) * (token.price || 0);
        const change24h = token.change24h || 0;
        const changeClass = change24h >= 0 ? 'change-positive' : 'change-negative';
        const changeSymbol = change24h >= 0 ? '+' : '';
        const formattedChange = changeSymbol + change24h.toFixed(2) + '%';
        const featuredClass = token.isFeatured ? 'featured' : '';

        const tokenCard = document.createElement('div');
        tokenCard.className = `token-card ${featuredClass}`;
        tokenCard.innerHTML = `
            <div class="token-icon ${token.symbol.toLowerCase()}-icon">
                <img src="${token.logo}" alt="${token.name}" class="token-icon-img" 
                     onerror="handleTokenLogoError(this, '${token.symbol}')">
                ${token.isFeatured ? '<div class="featured-star">‚≠ê</div>' : ''}
            </div>
            <div class="token-info">
                <div class="token-name">${token.name}</div>
                <div class="token-symbol">${token.symbol}</div>
                <div class="token-price">
                    $${token.price.toFixed(4)} 
                    <span class="token-change ${changeClass}">${formattedChange}</span>
                </div>
            </div>
            <div class="token-balance">
                <div class="token-amount">${token.balance.toFixed(4)}</div>
                <div class="token-value">$${tokenValue.toFixed(2)}</div>
            </div>
        `;
        tokenList.appendChild(tokenCard);
    });
}

function showWelcomeScreen() {
    console.log('üëã Showing welcome screen');
    walletState.isInitialized = false;
    walletState.sessionCheckComplete = true;
    updateWalletDisplay();
}

function closeModal() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
    });
}

function showStatusMessage(message, type = 'info') {
    console.log(`üì¢ Status (${type}): ${message}`);
    if (type === 'error') {
        alert('‚ùå ' + message);
    } else if (type === 'success') {
        alert('‚úÖ ' + message);
    }
}

function handleTokenLogoError(img, symbol) {
    img.style.display = 'none';
    const container = img.parentElement;
    container.innerHTML = symbol.charAt(0);
    container.style.background = 'rgba(255, 255, 255, 0.1)';
    container.style.color = 'white';
    container.style.fontWeight = 'bold';
    container.style.display = 'flex';
    container.style.alignItems = 'center';
    container.style.justifyContent = 'center';
}

// =============================================
// üöÄ INITIALIZATION
// =============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ DOM loaded, initializing wallet system...');
    
    const debugButtons = document.querySelectorAll('.debug-btn, .debug-button');
    debugButtons.forEach(button => button.remove());
    
    setTimeout(() => {
        initWallet();
    }, 500);
});

console.log('‚úÖ Enhanced Wallet System LOADED');
</script>
</body>
</html>