<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Migration - NemexCoin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .user-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .pending { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>User Migration to Supabase Auth</h1>
        <div id="status"></div>
        <div id="usersList"></div>
        <button onclick="loadUsers()" class="btn-primary">Load Users</button>
        <button onclick="migrateAllUsers()" class="btn-success">Migrate All Users</button>
    </div>

    <script>
        const supabaseUrl = 'https://bjulifvbfogymoduxnzl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqdWxpZnZiZm9neW1vZHV4bnpsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTkxOTQ0MywiZXhwIjoyMDc1NDk1NDQzfQ.6ChX_wWr2o1v2lwC3VvNbE6JwD6yUjAGJwvJkQqW8L8'; // Use service_role key
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let users = [];

        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                users = data || [];
                displayUsers();
            } catch (error) {
                document.getElementById('status').innerHTML = `<div class="error">Error loading users: ${error.message}</div>`;
            }
        }

        function displayUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = users.map(user => `
                <div class="user-card pending" id="user-${user.id}">
                    <h3>${user.email}</h3>
                    <p>ID: ${user.id}</p>
                    <p>Username: ${user.username || 'N/A'}</p>
                    <p>Created: ${new Date(user.created_at).toLocaleString()}</p>
                    <button onclick="migrateUser('${user.id}', '${user.email}', '${user.username || 'user'}')" class="btn-primary">Migrate</button>
                </div>
            `).join('');
        }

        async function migrateUser(userId, email, username) {
            try {
                const userCard = document.getElementById(`user-${userId}`);
                userCard.className = 'user-card pending';
                
                // Set a default password (users will reset it)
                const defaultPassword = 'TempPassword123!';
                
                // Create user in Supabase Auth
                const { data, error } = await supabase.auth.admin.createUser({
                    email: email,
                    password: defaultPassword,
                    email_confirm: true,
                    user_metadata: {
                        username: username
                    }
                });

                if (error) {
                    if (error.message.includes('already registered')) {
                        userCard.innerHTML += `<p style="color: green;">✅ Already in Auth system</p>`;
                    } else {
                        throw error;
                    }
                } else {
                    userCard.innerHTML += `<p style="color: green;">✅ Migrated successfully</p>`;
                }
                
                userCard.className = 'user-card success';

            } catch (error) {
                const userCard = document.getElementById(`user-${userId}`);
                userCard.innerHTML += `<p style="color: red;">❌ Error: ${error.message}</p>`;
                userCard.className = 'user-card error';
            }
        }

        async function migrateAllUsers() {
            for (const user of users) {
                await migrateUser(user.id, user.email, user.username || 'user');
                await new Promise(resolve => setTimeout(resolve, 500)); // Delay to avoid rate limits
            }
        }
    </script>
</body>
</html>