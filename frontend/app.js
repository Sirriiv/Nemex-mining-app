// ===== NMX APP - COMPACT VERSION =====
document.addEventListener('DOMContentLoaded', () => {
    // Auth forms
        const regForm = document.getElementById('registrationForm');
            const loginForm = document.getElementById('loginForm');
                if (regForm) regForm.addEventListener('submit', e => { e.preventDefault(); validateReg() && registerUser(); });
                    if (loginForm) loginForm.addEventListener('submit', e => { e.preventDefault(); validateLogin() && loginUser(); });

                        // Dashboard
                            if (document.querySelector('.dashboard')) {
                                    loadDashboard();
                                            initNav();
                                                    startMining();
                                                            initEvents();
                                                                }
                                                                    
                                                                        checkAuth();
                                                                        });

                                                                        // ===== AUTH FUNCTIONS =====
                                                                        function validateReg() {
                                                                            clearErrors();
                                                                                let valid = true;
                                                                                    
                                                                                        const tests = [
                                                                                                { id: 'fullName', cond: v => v.length >= 2, err: 'Name too short' },
                                                                                                        { id: 'email', cond: v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v), err: 'Invalid email' },
                                                                                                                { id: 'password', cond: v => v.length >= 6, err: 'Password too short' },
                                                                                                                        { id: 'confirmPassword', cond: v => v === document.getElementById('password').value, err: 'Passwords mismatch' }
                                                                                                                            ];
                                                                                                                                
                                                                                                                                    tests.forEach(({id, cond, err}) => {
                                                                                                                                            if (!cond(document.getElementById(id).value.trim())) {
                                                                                                                                                        showError(`${id}Error`, err);
                                                                                                                                                                    valid = false;
                                                                                                                                                                            }
                                                                                                                                                                                });
                                                                                                                                                                                    
                                                                                                                                                                                        if (!document.getElementById('terms').checked) {
                                                                                                                                                                                                showError('termsError', 'Accept terms');
                                                                                                                                                                                                        valid = false;
                                                                                                                                                                                                            }
                                                                                                                                                                                                                
                                                                                                                                                                                                                    return valid;
                                                                                                                                                                                                                    }

                                                                                                                                                                                                                    function validateLogin() {
                                                                                                                                                                                                                        clearErrors();
                                                                                                                                                                                                                            const email = document.getElementById('loginEmail').value.trim();
                                                                                                                                                                                                                                const pass = document.getElementById('loginPassword').value;
                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                                                                                                                                                                                                                                                showError('loginEmailError', 'Invalid email');
                                                                                                                                                                                                                                                        return false;
                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                if (!pass) {
                                                                                                                                                                                                                                                                        showError('loginPasswordError', 'Enter password');
                                                                                                                                                                                                                                                                                return false;
                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                        return true;
                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                        function registerUser() {
                                                                                                                                                                                                                                                                                            const user = {
                                                                                                                                                                                                                                                                                                    fullName: document.getElementById('fullName').value.trim(),
                                                                                                                                                                                                                                                                                                            email: document.getElementById('email').value.trim(),
                                                                                                                                                                                                                                                                                                                    password: document.getElementById('password').value,
                                                                                                                                                                                                                                                                                                                            balance: 0
                                                                                                                                                                                                                                                                                                                                };
                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                        let users = JSON.parse(localStorage.getItem('nmxUsers') || '[]');
                                                                                                                                                                                                                                                                                                                                            if (users.find(u => u.email === user.email)) {
                                                                                                                                                                                                                                                                                                                                                    showError('emailError', 'Email exists');
                                                                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                        users.push(user);
                                                                                                                                                                                                                                                                                                                                                                            localStorage.setItem('nmxUsers', JSON.stringify(users));
                                                                                                                                                                                                                                                                                                                                                                                localStorage.setItem('nmxCurrentUser', JSON.stringify(user));
                                                                                                                                                                                                                                                                                                                                                                                    alert('Welcome to NMX!');
                                                                                                                                                                                                                                                                                                                                                                                        window.location.href = 'dashboard.html';
                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                        function loginUser() {
                                                                                                                                                                                                                                                                                                                                                                                            const email = document.getElementById('loginEmail').value.trim();
                                                                                                                                                                                                                                                                                                                                                                                                const pass = document.getElementById('loginPassword').value;
                                                                                                                                                                                                                                                                                                                                                                                                    const users = JSON.parse(localStorage.getItem('nmxUsers') || '[]');
                                                                                                                                                                                                                                                                                                                                                                                                        const user = users.find(u => u.email === email && u.password === pass);
                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                if (user) {
                                                                                                                                                                                                                                                                                                                                                                                                                        localStorage.setItem('nmxCurrentUser', JSON.stringify(user));
                                                                                                                                                                                                                                                                                                                                                                                                                                alert('Welcome back!');
                                                                                                                                                                                                                                                                                                                                                                                                                                        window.location.href = 'dashboard.html';
                                                                                                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                    showError('loginPasswordError', 'Invalid login');
                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ===== DASHBOARD FUNCTIONS =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                        function loadDashboard() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                            const user = JSON.parse(localStorage.getItem('nmxCurrentUser'));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!user) { window.location.href = 'login.html'; return; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.querySelector('.balance-amount').textContent = (user.balance || 0).toString().padStart(2, '0');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function initNav() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.querySelectorAll('.nav-item').forEach(item => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    item.addEventListener('click', e => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                e.preventDefault();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.querySelectorAll('.nav-item, .content-section').forEach(el => el.classList.remove('active'));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        item.classList.add('active');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.getElementById(item.getAttribute('data-section')).classList.add('active');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                function startMining() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const timer = document.getElementById('claimTimer');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const amount = document.getElementById('miningAmount');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            let timeLeft = 10;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const update = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const h = Math.floor(timeLeft / 3600);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const m = Math.floor((timeLeft % 3600) / 60);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const s = timeLeft % 60;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            timer.textContent = `Claim in ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (timeLeft > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        timeLeft--;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    amount.classList.remove('ready-to-claim');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        timer.textContent = 'Ready to Claim!';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    amount.classList.add('ready-to-claim');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                amount.onclick = claimRewards;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    update();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        setInterval(update, 1000);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function claimRewards() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const user = JSON.parse(localStorage.getItem('nmxCurrentUser'));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!user) { window.location.href = 'login.html'; return; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const reward = 300;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const newBalance = (parseInt(document.querySelector('.balance-amount').textContent) || 0) + reward;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.querySelector('.balance-amount').textContent = newBalance.toString().padStart(2, '0');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        user.balance = newBalance;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            localStorage.setItem('nmxCurrentUser', JSON.stringify(user));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Update users array
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let users = JSON.parse(localStorage.getItem('nmxUsers') || '[]');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const userIndex = users.findIndex(u => u.email === user.email);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (userIndex !== -1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        users[userIndex].balance = newBalance;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                localStorage.setItem('nmxUsers', JSON.stringify(users));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('miningAmount').classList.remove('ready-to-claim');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                alert(`Claimed ${reward} NMXp!`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    startMining();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    function initEvents() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Logout
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    localStorage.removeItem('nmxCurrentUser');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            window.location.href = 'login.html';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Global event delegation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            document.addEventListener('click', e => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Task claiming
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (e.target.classList.contains('btn') && e.target.textContent === 'Claim' && e.target.closest('.task-item')) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const task = e.target.closest('.task-item');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const reward = parseInt(task.querySelector('.task-reward').textContent.match(/\d+/)[0]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const newBalance = (parseInt(document.querySelector('.balance-amount').textContent) || 0) + reward;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.querySelector('.balance-amount').textContent = newBalance.toString().padStart(2, '0');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const user = JSON.parse(localStorage.getItem('nmxCurrentUser'));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (user) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            user.balance = newBalance;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            localStorage.setItem('nmxCurrentUser', JSON.stringify(user));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                task.classList.remove('available');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            task.classList.add('completed');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        e.target.textContent = 'Completed';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    e.target.disabled = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                alert(`Earned ${reward} NMXp!`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Copy referral code
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (e.target.textContent === 'Copy Code') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            navigator.clipboard.writeText(document.querySelector('.code-display').textContent)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            .then(() => alert('Code copied!'));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ===== UTILITY FUNCTIONS =====
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function showError(id, msg) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const el = document.getElementById(id);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (el) { el.textContent = msg; el.style.display = 'block'; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                function clearErrors() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    document.querySelectorAll('.error-message').forEach(el => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            el.textContent = ''; el.style.display = 'none';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                function checkAuth() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const user = JSON.parse(localStorage.getItem('nmxCurrentUser'));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const page = window.location.pathname.split('/').pop();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (['dashboard.html'].includes(page) && !user) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    window.location.href = 'login.html';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }