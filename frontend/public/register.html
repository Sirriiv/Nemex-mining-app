// Initialize Supabase
const supabaseUrl = 'https://bjulifvbfogymoduxnzl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqdWxpZnZiZm9neW1vZHV4bnpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MTk0NDMsImV4cCI6MjA3NTQ5NTQ0M30.MPxDDybfODRnzvrFNZ0TQKkV983tGUFriHYgIpa_LaU';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
        
            const email = document.querySelector('input[type="email"]').value;
                const password = document.querySelector('input[type="password"]').value;
                    const confirmPassword = document.querySelectorAll('input[type="password"]')[1].value;
                        
                            // Check if passwords match
                                if (password !== confirmPassword) {
                                        alert('Passwords do not match!');
                                                return;
                                                    }
                                                        
                                                            try {
                                                                    // Try to create user
                                                                            const { data, error } = await supabase.auth.signUp({
                                                                                        email: email,
                                                                                                    password: password,
                                                                                                            });
                                                                                                                    
                                                                                                                            if (error) {
                                                                                                                                        // If email confirmation error, try sign-in instead
                                                                                                                                                    if (error.message.includes('email confirmation') || error.message.includes('anonymous')) {
                                                                                                                                                                    const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                                                                                                                                                                                        email: email,
                                                                                                                                                                                                            password: password
                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                            if (signInError) throw signInError;
                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                            alert('Account exists! Logging you in...');
                                                                                                                                                                                                                                                                                                            setTimeout(() => {
                                                                                                                                                                                                                                                                                                                                window.location.href = 'dashboard.html';
                                                                                                                                                                                                                                                                                                                                                }, 1000);
                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                            throw error;
                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                } else if (data.user) {
                                                                                                                                                                                                                                                                                                                                                                                                            alert('Account created successfully! Redirecting...');
                                                                                                                                                                                                                                                                                                                                                                                                                        setTimeout(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                        window.location.href = 'login.html';
                                                                                                                                                                                                                                                                                                                                                                                                                                                    }, 1000);
                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                alert('Error: ' + error.message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.error('Full error:', error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });