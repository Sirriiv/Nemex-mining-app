<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEMEXCOIN</title>
<style>
/* Your existing CSS styles remain the same */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Arial',sans-serif}
body{background:#0f0f1a;color:#fff;max-width:400px;margin:0 auto;padding-bottom:80px;overflow-x:hidden}
.loading{position:fixed;top:0;left:0;width:100%;height:100%;background:#0f0f1a;color:#d4af37;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:1000;transition:opacity 0.3s}
.loading-logo{font-size:72px;margin-bottom:20px;font-weight:700;animation:pulse 2s infinite}
.loading-status{font-size:16px;letter-spacing:0.5px}
.hidden{opacity:0;pointer-events:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
.header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid #1a1a2a;background:#0f0f1a}
.logo{font-weight:700;color:#d4af37;font-size:18px;letter-spacing:1px}
.dashboard{text-align:center;padding:40px 20px;animation:fadeIn 0.5s}
.balance{font-size:52px;font-weight:700;margin:20px 0;color:#d4af37;text-shadow:0 0 20px rgba(212,175,55,0.3)}
.chip-icon{font-size:32px;margin:20px 0;opacity:0.8}
.timer{font-size:14px;color:#aaa;margin:10px 0;letter-spacing:1px}
.claim-btn{background:linear-gradient(135deg,#d4af37,#b8941f);color:#0f0f1a;border:none;padding:14px 40px;border-radius:25px;font-size:16px;font-weight:600;margin:20px 0;cursor:pointer;transition:all 0.3s;box-shadow:0 4px 15px rgba(212,175,55,0.3)}
.claim-btn:active{transform:scale(0.95)}
.claim-btn:disabled{background:#333;color:#666;cursor:not-allowed;box-shadow:none}

/* UPDATED NAVIGATION STYLES */
.bottom-navbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 72px;
  background: linear-gradient(180deg, #0f0f1a 0%, #1a1a2a 100%);
  border-top: 1px solid rgba(212, 175, 55, 0.3);
  box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.6), 0 -2px 8px rgba(212, 175, 55, 0.1), inset 0 1px 0 rgba(212, 175, 55, 0.1);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 0 8px;
  z-index: 1000;
  backdrop-filter: blur(20px) saturate(180%);
  max-width: 400px;
  margin: 0 auto;
}

/* Navigation Items */
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  flex: 1;
  padding: 10px 8px;
  text-decoration: none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 16px;
  margin: 0 4px;
  position: relative;
  cursor: pointer;
  max-width: 80px;
  border: none;
  background: transparent;
  color: inherit;
}

/* Hover Effect */
.nav-item:hover {
  background: rgba(212, 175, 55, 0.08);
  transform: translateY(-3px);
}

.nav-item:hover::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 16px;
  padding: 1px;
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.3), rgba(212, 175, 55, 0.1));
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
}

/* Active State */
.nav-item.active {
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.08));
  position: relative;
}

.nav-item.active::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 16px;
  padding: 1.5px;
  background: linear-gradient(135deg, #d4af37, rgba(212, 175, 55, 0.4));
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
}

.nav-item.active::after {
  content: "";
  position: absolute;
  top: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 32px;
  height: 3px;
  background: linear-gradient(90deg, transparent, #d4af37, transparent);
  border-radius: 0 0 3px 3px;
  box-shadow: 0 0 12px rgba(212, 175, 55, 0.6);
}

/* Navigation Icons */
.nav-icon {
  width: 24px;
  height: 24px;
  color: #6b7280;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  stroke-width: 2.5;
  filter: drop-shadow(0 0 0 transparent);
  font-size: 22px;
  margin-bottom: 4px;
}

.nav-item:hover .nav-icon {
  color: #d4af37;
  transform: scale(1.1);
  filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.4));
}

.nav-item.active .nav-icon {
  color: #d4af37;
  filter: drop-shadow(0 0 12px rgba(212, 175, 55, 0.6));
  animation: iconPulse 2s ease-in-out infinite;
}

/* Navigation Labels */
.nav-label {
  font-size: 11px;
  font-weight: 600;
  color: #6b7280;
  text-align: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  line-height: 1.2;
  letter-spacing: 0.3px;
  text-transform: uppercase;
}

.nav-item:hover .nav-label {
  color: #d4af37;
  font-weight: 700;
  text-shadow: 0 0 8px rgba(212, 175, 55, 0.3);
}

.nav-item.active .nav-label {
  color: #d4af37;
  font-weight: 700;
  text-shadow: 0 0 12px rgba(212, 175, 55, 0.4);
}

/* Active State Animation */
@keyframes iconPulse {
  0%,
  100% {
    filter: drop-shadow(0 0 12px rgba(212, 175, 55, 0.6));
  }
  50% {
    filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.8));
  }
}

/* Safe area for notched phones */
@supports (padding-bottom: env(safe-area-inset-bottom)) {
  .bottom-navbar {
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
    height: calc(72px + env(safe-area-inset-bottom));
  }
}

/* Responsive Design */
@media (max-width: 380px) {
  .nav-label {
    font-size: 10px;
  }

  .nav-icon {
    width: 22px;
    height: 22px;
    font-size: 20px;
  }

  .nav-item {
    padding: 8px 6px;
    margin: 0 2px;
  }

  .bottom-navbar {
    height: 68px;
  }
}

@media (max-width: 320px) {
  .nav-label {
    font-size: 9px;
  }

  .nav-icon {
    width: 20px;
    height: 20px;
    font-size: 18px;
  }

  .nav-item {
    padding: 6px 4px;
    margin: 0 1px;
  }

  .bottom-navbar {
    height: 64px;
    padding: 0 4px;
  }
}

/* Focus states for accessibility */
.nav-item:focus-visible {
  outline: 2px solid #d4af37;
  outline-offset: 2px;
  background: rgba(212, 175, 55, 0.1);
}

/* Reduced motion for accessibility */
@media (prefers-reduced-motion: reduce) {
  .nav-item,
  .nav-icon,
  .nav-label {
    transition: none;
  }

  .nav-item.active .nav-icon {
    animation: none;
  }

  .nav-item:hover {
    transform: none;
  }

  .nav-item:hover .nav-icon {
    transform: none;
  }
}

/* Loading animation */
@keyframes navSlideUp {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.bottom-navbar {
  animation: navSlideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Prevent content from being hidden behind navbar */
body {
  padding-bottom: 72px;
}

@supports (padding-bottom: env(safe-area-inset-bottom)) {
  body {
    padding-bottom: calc(72px + env(safe-area-inset-bottom));
  }
}

.section{display:none;padding:30px 20px;text-align:center;animation:fadeIn 0.5s}
.section.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.section h2{color:#d4af37;margin-bottom:15px;font-size:24px}
.section p{color:#aaa;line-height:1.5}

/* NEW SETTINGS STYLES */
.settings-icon{cursor:pointer;transition:transform 0.3s}
.settings-icon:hover{transform:scale(1.1)}
.settings-menu{position:absolute;top:60px;right:20px;background:#1a1a2a;border:1px solid #2a2a3a;border-radius:10px;padding:15px;min-width:180px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:1001;display:none}
.settings-menu.active{display:block;animation:fadeIn 0.3s}
.settings-item{display:flex;align-items:center;padding:12px 15px;cursor:pointer;border-radius:8px;transition:background 0.3s;margin-bottom:5px}
.settings-item:hover{background:#2a2a3a}
.settings-item:last-child{margin-bottom:0}
.settings-icon-small{font-size:18px;margin-right:12px;width:20px;text-align:center}
.settings-label{font-size:14px;color:#fff}
.settings-divider{height:1px;background:#2a2a3a;margin:8px 0}
.logout-btn{color:#ff6b6b}
.logout-btn:hover{background:rgba(255,107,107,0.1)}

/* Overlay for when settings is open */
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:none}
.overlay.active{display:block}

/* PROFILE MODAL STYLES */
.profile-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a2a;border:1px solid #2a2a3a;border-radius:15px;padding:25px;width:90%;max-width:350px;z-index:1002;display:none;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.profile-modal.active{display:block;animation:fadeIn 0.3s}
.profile-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #2a2a3a}
.profile-title{font-size:20px;font-weight:700;color:#d4af37}
.close-btn{background:none;border:none;color:#aaa;font-size:20px;cursor:pointer;padding:5px;border-radius:5px}
.close-btn:hover{color:#fff;background:#2a2a3a}
.profile-info{text-align:left}
.profile-item{margin-bottom:20px;padding:15px;background:#0f0f1a;border-radius:10px;border:1px solid #2a2a3a}
.profile-label{font-size:12px;color:#d4af37;margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.profile-value{font-size:16px;color:#fff;word-break:break-all}
.copy-btn{background:#2a2a3a;color:#d4af37;border:1px solid #d4af37;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer;margin-left:10px;transition:all 0.3s}
.copy-btn:hover{background:#d4af37;color:#0f0f1a}
.value-row{display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
<div id="loading" class="loading hidden">
    <div class="loading-logo">NMX</div>
    <div class="loading-status">Initializing…</div>
</div>

<!-- Settings Overlay -->
<div id="overlay" class="overlay"></div>

<!-- Settings Menu -->
<div id="settingsMenu" class="settings-menu">
    <div class="settings-item" id="profileBtn">
        <div class="settings-icon-small">👤</div>
        <div class="settings-label">Profile</div>
    </div>
    <div class="settings-item">
        <div class="settings-icon-small">🔔</div>
        <div class="settings-label">Notifications</div>
    </div>
    <div class="settings-item">
        <div class="settings-icon-small">🌙</div>
        <div class="settings-label">Dark Mode</div>
    </div>
    <div class="settings-item">
        <div class="settings-icon-small">🔒</div>
        <div class="settings-label">Security</div>
    </div>
    <div class="settings-divider"></div>
    <div class="settings-item">
        <div class="settings-icon-small">❓</div>
        <div class="settings-label">Help & Support</div>
    </div>
    <div class="settings-item">
        <div class="settings-icon-small">ℹ️</div>
        <div class="settings-label">About</div>
    </div>
    <div class="settings-divider"></div>
    <div class="settings-item logout-btn">
        <div class="settings-icon-small">🚪</div>
        <div class="settings-label">Logout</div>
    </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="profile-modal">
    <div class="profile-header">
        <div class="profile-title">👤 User Profile</div>
        <button class="close-btn" id="closeProfile">✕</button>
    </div>
    <div class="profile-info">
        <div class="profile-item">
            <div class="profile-label">Name</div>
            <div class="profile-value" id="profileName">Mining Enthusiast</div>
        </div>
        <div class="profile-item">
            <div class="profile-label">Email</div>
            <div class="profile-value" id="profileEmail">user@nemexcoin.com</div>
        </div>
        <div class="profile-item">
            <div class="profile-label">User ID</div>
            <div class="value-row">
                <div class="profile-value" id="profileUserId">Loading...</div>
                <button class="copy-btn" onclick="copyToClipboard('profileUserId')">Copy</button>
            </div>
        </div>
        <div class="profile-item">
            <div class="profile-label">Days on Mining</div>
            <div class="profile-value" id="profileMiningDays">1 day</div>
        </div>
        <div class="profile-item">
            <div class="profile-label">Total NMXp Earned</div>
            <div class="profile-value" id="profileTotalEarned">0 NMXp</div>
        </div>
        <div class="profile-item">
            <div class="profile-label">Member Since</div>
            <div class="profile-value" id="profileMemberSince">Today</div>
        </div>
    </div>
</div>

<div class="header">
    <div class="logo">NEMEXCOIN</div>
    <div class="settings-icon" id="settingsButton">⚙️</div>
</div>

<div id="home" class="section active">
    <div class="dashboard">
        <div class="balance" id="balanceDisplay">00</div>
        <div class="chip-icon">💿</div>
        <div class="timer" id="timerDisplay">Claim in 24:00:00</div>
        <button class="claim-btn" id="claimButton" disabled>30 NMXp</button>
    </div>
</div>

<div id="tasks" class="section">
    <h2>📋 Tasks</h2>
    <p>Complete daily tasks and challenges to earn bonus NMX rewards</p>
</div>

<div id="buy" class="section">
    <h2>🛒 Buy NMXp</h2>
    <p>Purchase NMX(points) tokens securely with multiple payment options</p>
</div>

<div id="referrals" class="section">
    <h2>👥 Referrals</h2>
    <p>Invite friends and earn mining rewards</p>
</div>

<div id="wallet" class="section">
    <h2>💰 Wallet</h2>
    <p>Manage your assets and NMXp balance and transaction history</p>
</div>

<!-- UPDATED NAVIGATION -->
<nav class="bottom-navbar">
  <button class="nav-item active" data-section="home">
    <div class="nav-icon">🏠</div>
    <div class="nav-label">Home</div>
  </button>
  <button class="nav-item" data-section="tasks">
    <div class="nav-icon">📋</div>
    <div class="nav-label">Tasks</div>
  </button>
  <button class="nav-item" data-section="buy">
    <div class="nav-icon">🛒</div>
    <div class="nav-label">Buy</div>
  </button>
  <button class="nav-item" data-section="referrals">
    <div class="nav-icon">👥</div>
    <div class="nav-label">Referrals</div>
  </button>
  <button class="nav-item" data-section="wallet">
    <div class="nav-icon">💰</div>
    <div class="nav-label">Wallet</div>
  </button>
</nav>

<script>
// Tab Switching Code
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function() {
        const target = this.getAttribute('data-section');
        const loading = document.getElementById('loading');
        
        loading.classList.remove('hidden');
        
        setTimeout(() => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(target).classList.add('active');
            this.classList.add('active');
            
            setTimeout(() => loading.classList.add('hidden'), 300);
        }, 1500);
    });
});

// SETTINGS MENU FUNCTIONALITY
const settingsButton = document.getElementById('settingsButton');
const settingsMenu = document.getElementById('settingsMenu');
const overlay = document.getElementById('overlay');
const profileModal = document.getElementById('profileModal');
const closeProfile = document.getElementById('closeProfile');
const profileBtn = document.getElementById('profileBtn');

// Toggle settings menu
settingsButton.addEventListener('click', function(e) {
    e.stopPropagation();
    settingsMenu.classList.toggle('active');
    overlay.classList.toggle('active');
});

// Close settings when clicking outside
overlay.addEventListener('click', function() {
    settingsMenu.classList.remove('active');
    overlay.classList.remove('active');
    profileModal.classList.remove('active');
});

// Close settings when clicking on overlay
document.addEventListener('click', function(e) {
    if (!settingsMenu.contains(e.target) && e.target !== settingsButton) {
        settingsMenu.classList.remove('active');
        overlay.classList.remove('active');
    }
});

// PROFILE MODAL FUNCTIONALITY
profileBtn.addEventListener('click', function() {
    settingsMenu.classList.remove('active');
    loadProfileData();
    profileModal.classList.add('active');
    overlay.classList.add('active');
});

closeProfile.addEventListener('click', function() {
    profileModal.classList.remove('active');
    overlay.classList.remove('active');
});

// Load profile data from DATABASE
async function loadProfileData() {
    try {
        showLoading('Loading profile...');
        
        const response = await fetch(`${API_BASE}/api/profile/${currentUserId}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to load profile');
        }
        
        // Update profile fields with REAL database data
        document.getElementById('profileName').textContent = data.name;
        document.getElementById('profileEmail').textContent = data.email;
        document.getElementById('profileUserId').textContent = data.userId;
        document.getElementById('profileMiningDays').textContent = `${data.miningDays} day${data.miningDays > 1 ? 's' : ''}`;
        document.getElementById('profileTotalEarned').textContent = `${data.totalEarned} NMXp`;
        
        // FIXED: Better date formatting for Member Since
        const memberSinceDate = new Date(data.memberSince);
        const formattedDate = memberSinceDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('profileMemberSince').textContent = formattedDate;
        
        // Debug logging
        console.log('Profile data loaded:', {
            memberSince: data.memberSince,
            formattedDate: formattedDate,
            rawDate: memberSinceDate.toString()
        });
        
        hideLoading();
    } catch (error) {
        console.error('Error loading profile:', error);
        hideLoading();
        // Fallback to localStorage if backend fails
        fallbackToLocalProfile();
    }
}

// Fallback to localStorage if backend fails
function fallbackToLocalProfile() {
    const userId = localStorage.getItem('userId') || currentUserId;
    const joinDate = localStorage.getItem('joinDate') || new Date().toISOString();
    const totalEarned = localStorage.getItem('totalEarned') || 0;
    
    // Calculate days since joining
    const joinDateObj = new Date(joinDate);
    const today = new Date();
    const daysSinceJoin = Math.floor((today - joinDateObj) / (1000 * 60 * 60 * 24));
    const miningDays = daysSinceJoin + 1;
    
    // Update profile fields
    document.getElementById('profileName').textContent = 'Mining Enthusiast';
    document.getElementById('profileEmail').textContent = `user_${userId.substring(0, 8)}@nemexcoin.com`;
    document.getElementById('profileUserId').textContent = userId;
    document.getElementById('profileMiningDays').textContent = `${miningDays} day${miningDays > 1 ? 's' : ''}`;
    document.getElementById('profileTotalEarned').textContent = `${totalEarned} NMXp`;
    
    // FIXED: Better date formatting for fallback
    const formattedDate = joinDateObj.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    document.getElementById('profileMemberSince').textContent = formattedDate;
    
    alert('⚠️ Using offline profile data.');
}

// Copy to clipboard function
function copyToClipboard(elementId) {
    const text = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(text).then(function() {
        alert('Copied to clipboard!');
    }).catch(function() {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Copied to clipboard!');
    });
}

// Settings menu items functionality
document.querySelectorAll('.settings-item').forEach(item => {
    if (item.id !== 'profileBtn') {
        item.addEventListener('click', function() {
            const label = this.querySelector('.settings-label').textContent;
            
            switch(label) {
                case 'Notifications':
                    alert('🔔 Notification settings coming soon!');
                    break;
                case 'Dark Mode':
                    alert('🌙 Dark mode is already enabled!');
                    break;
                case 'Security':
                    alert('🔒 Security settings coming soon!');
                    break;
                case 'Help & Support':
                    alert('❓ Help & support coming soon!');
                    break;
                case 'About':
                    alert('ℹ️ NEMEXCOIN v1.0 - Crypto Rewards Platform');
                    break;
                case 'Logout':
                    if(confirm('Are you sure you want to logout?')) {
                        localStorage.clear();
                        window.location.href = 'index.html';
                    }
                    break;
            }
            
            // Close menu after selection
            settingsMenu.classList.remove('active');
            overlay.classList.remove('active');
        });
    }
});

// SUPABASE-BACKED COUNTDOWN TIMER
const API_BASE = 'https://nemex-backend.onrender.com';
let countdownInterval;
let currentUserId = localStorage.getItem('userId') || generateUserId();

// Get elements
const timerDisplay = document.getElementById('timerDisplay');
const balanceDisplay = document.getElementById('balanceDisplay');
const claimButton = document.getElementById('claimButton');

// Generate unique user ID
function generateUserId() {
    const userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    localStorage.setItem('userId', userId);
    return userId;
}

// Format time as HH:MM:SS
function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Load user data from backend
async function loadUserData() {
    try {
        showLoading('Loading your data...');
        
        const response = await fetch(`${API_BASE}/api/user/${currentUserId}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to load user data');
        }
        
        balanceDisplay.textContent = data.balance;
        
        if (data.remainingTime > 0) {
            startCountdown(data.remainingTime);
            claimButton.disabled = true;
            claimButton.textContent = '30 NMXp';
        } else {
            timerDisplay.textContent = 'Ready to Claim!';
            claimButton.disabled = false;
            claimButton.textContent = 'CLAIM 30 NMXp';
        }
        
        hideLoading();
    } catch (error) {
        console.error('Error loading user data:', error);
        hideLoading();
        // Fallback to localStorage if backend fails
        fallbackToLocalStorage();
    }
}

// Show loading state
function showLoading(message = 'Loading...') {
    const loading = document.getElementById('loading');
    const status = loading.querySelector('.loading-status');
    status.textContent = message;
    loading.classList.remove('hidden');
}

// Hide loading state
function hideLoading() {
    setTimeout(() => {
        document.getElementById('loading').classList.add('hidden');
    }, 500);
}

// Start countdown timer
function startCountdown(initialTime) {
    let remainingTime = initialTime;
    
    clearInterval(countdownInterval);
    
    function update() {
        if (remainingTime > 0) {
            timerDisplay.textContent = `Claim in ${formatTime(remainingTime)}`;
            remainingTime--;
            
            // Auto-save progress every minute
            if (remainingTime % 60 === 0) {
                localStorage.setItem('backupCountdown', remainingTime);
                localStorage.setItem('backupLastUpdate', Date.now());
            }
        } else {
            timerDisplay.textContent = 'Ready to Claim!';
            claimButton.disabled = false;
            claimButton.textContent = 'CLAIM 30 NMXp';
            clearInterval(countdownInterval);
        }
    }
    
    update(); // Initial update
    countdownInterval = setInterval(update, 1000);
}

// Claim reward function
async function claimReward() {
    try {
        claimButton.disabled = true;
        claimButton.textContent = 'Claiming...';
        
        const response = await fetch(`${API_BASE}/api/claim/${currentUserId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        const data = await response.json();
        
        if (response.ok) {
            balanceDisplay.textContent = data.balance;
            startCountdown(24 * 60 * 60); // Reset to 24 hours
            claimButton.textContent = '30 NMXp';
            
            // Show success message
            alert('✅ ' + data.message);
        } else {
            alert('❌ Error: ' + data.error);
            claimButton.disabled = false;
            claimButton.textContent = 'CLAIM 30 NMXp';
        }
    } catch (error) {
        console.error('Error claiming reward:', error);
        alert('❌ Network error. Please try again.');
        claimButton.disabled = false;
        claimButton.textContent = 'CLAIM 30 NMXp';
    }
}

// Fallback to localStorage if backend fails
function fallbackToLocalStorage() {
    const savedBalance = localStorage.getItem('nmxBalance');
    const savedCountdown = localStorage.getItem('backupCountdown');
    const savedLastUpdate = localStorage.getItem('backupLastUpdate');
    
    if (savedBalance) {
        balanceDisplay.textContent = savedBalance;
    }
    
    if (savedCountdown && savedLastUpdate) {
        const elapsedSeconds = Math.floor((Date.now() - parseInt(savedLastUpdate)) / 1000);
        const remainingTime = Math.max(0, parseInt(savedCountdown) - elapsedSeconds);
        startCountdown(remainingTime);
    } else {
        startCountdown(24 * 60 * 60);
    }
    
    alert('⚠️ Using offline mode. Some features may be limited.');
}

// Initialize
loadUserData();
claimButton.addEventListener('click', claimReward);
</script>
</body>
</html>